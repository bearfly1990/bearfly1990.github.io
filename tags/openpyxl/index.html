<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Tag: openpyxl - BF Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="BF Blog"><meta name="msapplication-TileImage" content="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="BF Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="BF Blog"><meta property="og:url" content="https://bearfly1990.github.io/"><meta property="og:site_name" content="BF Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://bearfly1990.github.io/img/og_image.png"><meta property="article:author" content="bearfly1990"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bearfly1990.github.io"},"headline":"BF Blog","image":["https://bearfly1990.github.io/img/og_image.png"],"author":{"@type":"Person","name":"bearfly1990"},"publisher":{"@type":"Organization","name":"BF Blog","logo":{"@type":"ImageObject","url":"https://bearfly1990.github.io/img/favicon.ico"}},"description":""}</script><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.ico" alt="BF Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bearfly1990"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">openpyxl</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-03-10T16:00:00.000Z" title="2021/3/11 上午12:00:00">2021-03-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-11T14:06:59.606Z" title="2021/3/11 下午10:06:59">2021-03-11</time></span><span class="level-item"> BF </span><span class="level-item">7 minutes read (About 1076 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/11/2021/03/2021-03-11-HareData/">Pandas + Openpyxl process excel</a></h1><div class="content"><h1 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h1><table>
<thead>
<tr>
<th>date</th>
<th>update</th>
</tr>
</thead>
<tbody><tr>
<td>2021-03-11</td>
<td>1. Initial</td>
</tr>
</tbody></table>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近帮同学写了一个数据处理的小程序，用<code>python</code>开发，用来处理excel数据。</p>
<p>其实excel本身就能实现大部分功能，并不一定要用程序处理，但用代码的话更灵活一些。</p>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>数据本身不能share，但是计算逻辑应该无所谓，所以代码已经放在<a target="_blank" rel="noopener" href="https://github.com/bearfly1990/haredata">haredata</a>。</p>
<p>程序主要用到了python库<code>pandas + openpyxl</code>，写了非常简单的<code>ui</code>界面来选择输入的文件，处理完之后数据输出写入到新的文件里。</p>
<p>为了使用方便，最后打包成了exe。</p>
<h2 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h2><p><img src="/img/post/2021/03/2020-03-11-HareData-01.jpg" alt="my wechat video QR"></p>
<p>在做上面的界面的时候，遇到一个问题，就是需要给界面上加图标， 就是上面左上角的钥匙孔。</p>
<p>在打包exe的时候，需要把图片也打包进去，不然就需要带着额外的数据文件，不能放在一个exe中了，会比较挫。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/MemoryD/article/details/83147300">Pyinstaller 使用+打包图片方法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/darcymei/p/9397173.html">Pyinstaller如何将资源文件一起打包至exe中</a></li>
</ul>
<p>上面是网上找到的比较好的两个方法，第一个方法只适合图片，有点绕。</p>
<p>第二个方法能直接解决打包数据文件的问题，可以参考一下。</p>
<p>两种方法都是用临时文件，只不过第二种方法更方便一些，使用系统的临时文件夹，不用自己操心。</p>
<h2 id="Pandas计算"><a href="#Pandas计算" class="headerlink" title="Pandas计算"></a>Pandas计算</h2><p>在数据处理过程中，用到了pandas的一些数值聚合计算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logger.info(<span class="string">&#x27;计算n...&#x27;</span>)</span><br><span class="line">self.df_sheet_weight[<span class="string">&#x27;n&#x27;</span>] = self.df_sheet_weight.apply(<span class="keyword">lambda</span> x: self.n(x), axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">&#x27;计算n2...&#x27;</span>)</span><br><span class="line">self.df_sheet_weight[<span class="string">&#x27;n2&#x27;</span>] = self.df_sheet_weight.apply(<span class="keyword">lambda</span> x: self.n2(x), axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n2</span>(<span class="params">self, x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.df_sheet_weight.groupby([<span class="string">&#x27;DSDM&#x27;</span>]).size()[x[<span class="string">&#x27;DSDM&#x27;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c1_county</span>(<span class="params">self, x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.df_sheet_weight.groupby([<span class="string">&#x27;QXDM&#x27;</span>])[<span class="string">&#x27;C1/WA&#x27;</span>].<span class="built_in">sum</span>()[x[<span class="string">&#x27;QXDM&#x27;</span>]] / x[<span class="string">&#x27;n&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c1_city</span>(<span class="params">self, x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.df_sheet_weight.groupby([<span class="string">&#x27;DSDM&#x27;</span>])[<span class="string">&#x27;C1/WA2&#x27;</span>].<span class="built_in">sum</span>()[x[<span class="string">&#x27;DSDM&#x27;</span>]] / x[<span class="string">&#x27;n2&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c1_pro</span>(<span class="params">self, x</span>):</span>  <span class="comment"># C1pro</span></span><br><span class="line">    <span class="keyword">return</span> self.df_sheet_weight[<span class="string">&#x27;C1/WA3&#x27;</span>].<span class="built_in">sum</span>() / x[<span class="string">&#x27;n3&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="单元格长度自适应"><a href="#单元格长度自适应" class="headerlink" title="单元格长度自适应"></a>单元格长度自适应</h2><p>因为数值比较多，所以添加了<code>cell</code>长度自适应，因为中文字符是英文的两倍，也添加了判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auto_width</span>(<span class="params">cls, sheet</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, sheet.max_column + <span class="number">1</span>):</span><br><span class="line">        max_width = <span class="number">13</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, sheet.max_row + <span class="number">1</span>):</span><br><span class="line">            cell = <span class="string">f&#x27;<span class="subst">&#123;OpenpyxlHelper.get_column_letter_from_index(i)&#125;</span><span class="subst">&#123;j&#125;</span>&#x27;</span></span><br><span class="line">            value_width = <span class="number">0.7</span> * <span class="built_in">len</span>(re.findall(<span class="string">&#x27;([\u4e00-\u9fa5])&#x27;</span>, <span class="built_in">str</span>(sheet[cell].value))) + <span class="built_in">len</span>(</span><br><span class="line">                <span class="built_in">str</span>(sheet[cell].value))</span><br><span class="line">            <span class="keyword">if</span> value_width &gt; max_width:</span><br><span class="line">                max_width = value_width</span><br><span class="line">        sheet.column_dimensions[OpenpyxlHelper.get_column_letter_from_index(i)].width = max_width + <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="Openpyxl给单元格赋值及应用样式"><a href="#Openpyxl给单元格赋值及应用样式" class="headerlink" title="Openpyxl给单元格赋值及应用样式"></a>Openpyxl给单元格赋值及应用样式</h2><p>下面是一个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_summary</span>(<span class="params">sheet_summary, df_summary, row_start, col_start_char, diff</span>):</span></span><br><span class="line">    col_start_char = OpenpyxlHelper.get_column_letter_from_str_by_diff(col_start_char, diff)</span><br><span class="line">    row_current = row_start</span><br><span class="line">    <span class="keyword">for</span> index, row <span class="keyword">in</span> df_summary.iterrows():</span><br><span class="line">        <span class="keyword">for</span> i, crop <span class="keyword">in</span> <span class="built_in">enumerate</span>(CROPS_LIST):</span><br><span class="line">            cell = sheet_summary.cell(row=row_current,</span><br><span class="line">                                      column=OpenpyxlHelper.get_column_index_from_str(col_start_char) + i)</span><br><span class="line">            cell.value = row[i]</span><br><span class="line">            cell.number_format = <span class="string">&#x27;#,##0.00&#x27;</span></span><br><span class="line"></span><br><span class="line">            cell = sheet_summary.cell(</span><br><span class="line">                row=row_current, column=OpenpyxlHelper.get_column_index_from_str_by_diff(col_start_char, -<span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line">            start_cell = <span class="string">f&#x27;<span class="subst">&#123;col_start_char&#125;</span><span class="subst">&#123;row_current&#125;</span>&#x27;</span></span><br><span class="line">            ended_cell = <span class="string">f&#x27;<span class="subst">&#123;OpenpyxlHelper.get_column_letter_from_str_by_diff(col_start_char, <span class="built_in">len</span>(CROPS_LIST) - <span class="number">1</span>)&#125;</span><span class="subst">&#123;row_current&#125;</span>&#x27;</span></span><br><span class="line">            cell.value = <span class="string">f&#x27;=sum(<span class="subst">&#123;start_cell&#125;</span>:<span class="subst">&#123;ended_cell&#125;</span>)&#x27;</span></span><br><span class="line">            cell.number_format = <span class="string">&#x27;#,##0.00&#x27;</span></span><br><span class="line">            row_current = row_current + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>创建了一个辅助类来控制样式和列名的index与letter转换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenpyxlHelper</span>:</span></span><br><span class="line">    align_left = Alignment(horizontal=<span class="string">&#x27;left&#x27;</span>, vertical=<span class="string">&#x27;center&#x27;</span>, wrap_text=<span class="literal">True</span>)</span><br><span class="line">    align_right = Alignment(horizontal=<span class="string">&#x27;right&#x27;</span>, vertical=<span class="string">&#x27;center&#x27;</span>, wrap_text=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_column_letter_from_index</span>(<span class="params">cls, val_int</span>):</span></span><br><span class="line">        <span class="keyword">return</span> get_column_letter(val_int)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_column_index_from_str</span>(<span class="params">cls, val_str</span>):</span></span><br><span class="line">        <span class="keyword">return</span> column_index_from_string(val_str)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_column_letter_from_str_by_diff</span>(<span class="params">cls, val_str, diff</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.get_column_letter_from_index(cls.get_column_index_from_str(val_str) + diff)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_column_index_from_str_by_diff</span>(<span class="params">cls, val_str, diff</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.get_column_index_from_str(val_str) + diff</span><br></pre></td></tr></table></figure>



<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>内容和细节还有很多，完整代码在<a target="_blank" rel="noopener" href="https://github.com/bearfly1990/haredata">haredata</a></p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/MemoryD/article/details/83147300">Pyinstaller 使用+打包图片方法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/darcymei/p/9397173.html">Pyinstaller如何将资源文件一起打包至exe中</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44244920/article/details/111270305?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&dist_request_id=1328626.20828.16154238288737745&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control">PYTHON模块openpyxl在导出EXCEL文件时设置自动列宽</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-11-09T16:00:00.000Z" title="2019/11/10 上午12:00:00">2019-11-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-09-08T15:43:26.420Z" title="2020/9/8 下午11:43:26">2020-09-08</time></span><span class="level-item"> BF </span><span class="level-item">7 minutes read (About 1028 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/11/10/2019/11/2019-11-10-OpenpyxlWithHugeData/">openpyxl with big data</a></h1><div class="content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近写了一个脚本，用 openpyxl 从 sql server 数据库中读取数据，使用 template 文件，将数据填充进去，生成最后的 daily report。</p>
<p>使用 openpyxl 来操作 excel，很方便,但发现当要写入大量数据的时候，时间非常慢，而且非常占内存。</p>
<p>最直接的原因是 openpyxl 会将读写过的 cell 都加载在内存中方便后面 update，不会释放这些 cell 而会一直驻留在内存中。</p>
<p>所以如果单纯写的话建议使用 xlrd，而且 pandas 有 to_csv/to_excel 这样的直接的方法。</p>
<p>但是因为我需要使用模板，在研究后发现 openpyxl 有 read_only/write_only 的模式，可以满足我的需求。<br>(一定要保证安装了 lxml 库，不然就算使用 write_only 模式，也一样会点用大量占存。）</p>
<p>Note：针对 office2007 以后的版本，xlsx 文件上限行数大约为 100 多万条的样子。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><ol>
<li>从数据库中得到想要的数据</li>
<li>读取 template 文件，保留 template 的样式</li>
<li>写入新的 output 文件中</li>
</ol>
<h2 id="数据库中的数据"><a href="#数据库中的数据" class="headerlink" title="数据库中的数据"></a>数据库中的数据</h2><p><img src="/img/post/2019/11/2019-11-10-OpenpyxlWithHugeData_DB01.png" alt="2019-11-10-OpenpyxlWithHugeData_DB01.png"></p>
<h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><p><img src="/img/post/2019/11/2019-11-10-OpenpyxlWithHugeData_TPL01.png" alt="2019-11-10-OpenpyxlWithHugeData_TPL01.png"></p>
<h1 id="直接使用-oponpyxl"><a href="#直接使用-oponpyxl" class="headerlink" title="直接使用 oponpyxl"></a>直接使用 oponpyxl</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> pyodbc</span><br><span class="line"><span class="keyword">import</span> openpyxl</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">conn=pyodbc.connect(<span class="string">r&#x27;DRIVER=&#123;SQL Server&#125;;SERVER=PC-CX\SQLEXPRESS;UID=test;PWD=test&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger_info</span>(<span class="params">message</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;datetime.now()&#125;</span>[INFO]&#x27;</span>, message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_data_from_db</span>(<span class="params">conn</span>):</span></span><br><span class="line">    sql_str = <span class="string">&#x27;select UserName, Age, Country, [Status] from [BFTest].[dbo].[Test_Output]&#x27;</span></span><br><span class="line">    sql_query = pd.read_sql_query(sql_str, conn)</span><br><span class="line">    df_output_db = pd.DataFrame(sql_query)</span><br><span class="line">    <span class="keyword">return</span> df_output_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_excel</span>(<span class="params">template, report</span>):</span></span><br><span class="line">    workbook = openpyxl.load_workbook(template)</span><br><span class="line">    ws_report = workbook[<span class="string">&#x27;report&#x27;</span>]</span><br><span class="line">    row_start = <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> idx_row, row <span class="keyword">in</span> df_output_db.iterrows():</span><br><span class="line">        <span class="keyword">for</span> idx_col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(row)):</span><br><span class="line">            ws_report.cell(column = idx_col+<span class="number">1</span>, row = row_start + idx_row).value = row[idx_col]</span><br><span class="line">    workbook.save(report)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_time = datetime.now()</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;query data from db&#x27;</span>)</span><br><span class="line">    df_output_db = query_data_from_db(conn)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;write to excel&#x27;</span>)</span><br><span class="line">    write_to_excel(<span class="string">&#x27;template.xlsx&#x27;</span>, <span class="string">&#x27;report.xlsx&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    end_time = datetime.now()</span><br><span class="line">    logger_info(<span class="string">f&#x27;cost time:<span class="subst">&#123;end_time-start_time&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最后的结果：<br><img src="/img/post/2019/11/2019-11-10-OpenpyxlWithHugeData_Report01.png" alt="2019-11-10-OpenpyxlWithHugeData_Report01.png"></p>
<h2 id="增加数据量"><a href="#增加数据量" class="headerlink" title="增加数据量"></a>增加数据量</h2><p>现在让我们把数据量加上去一些，再看结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">large_data</span>(<span class="params">df</span>):</span></span><br><span class="line">    df_large = df.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">        df = df_large.copy()</span><br><span class="line">        df_large=pd.concat([df_large,df])</span><br><span class="line">    <span class="keyword">return</span> df_large</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_time = datetime.now()</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;query data from db&#x27;</span>)</span><br><span class="line">    df_output_db = query_data_from_db(conn)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;large data&#x27;</span>)</span><br><span class="line">    df_output_db = large_data(df_output_db)</span><br><span class="line">    df_output_db = df_output_db.reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    logger_info(<span class="string">f&#x27;count data:<span class="subst">&#123;<span class="built_in">len</span>(df_output_db)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;write to excel&#x27;</span>)</span><br><span class="line">    start_time_excel = datetime.now()</span><br><span class="line">    write_to_excel(<span class="string">&#x27;template.xlsx&#x27;</span>, <span class="string">&#x27;report.xlsx&#x27;</span>)</span><br><span class="line">    logger_info(<span class="string">f&#x27;write to excel cost time:<span class="subst">&#123;datetime.now() - start_time_excel&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">f&#x27;cost time:<span class="subst">&#123;datetime.now()-start_time&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>数据量加到了 131072,一共使用了 26 秒。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\GitSpace\PowerScript\Python3\openpyxl\generate_report&gt; python .\generate_report.hugedata.py</span><br><span class="line">2019-11-10 10:50:02.332573[INFO] query data from db</span><br><span class="line">2019-11-10 10:50:02.334600[INFO] large data</span><br><span class="line">2019-11-10 10:50:02.370501[INFO] count data:131072</span><br><span class="line">2019-11-10 10:50:02.370501[INFO] write to excel</span><br><span class="line">2019-11-10 10:50:28.605598[INFO] write to excel cost time:0:00:26.234127</span><br><span class="line">2019-11-10 10:50:28.606598[INFO] cost time:0:00:26.274025</span><br></pre></td></tr></table></figure>

<h1 id="使用-write-only"><a href="#使用-write-only" class="headerlink" title="使用 write_only"></a>使用 write_only</h1><p>先写 template 的表头，再写内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_excel</span>(<span class="params">template, report</span>):</span></span><br><span class="line">    wb_tpl = openpyxl.load_workbook(template)</span><br><span class="line">    ws_report_tpl = wb_tpl[<span class="string">&#x27;report&#x27;</span>] <span class="comment">#workbook.get_sheet_by_name(&#x27;report&#x27;)</span></span><br><span class="line">    </span><br><span class="line">    workbook = openpyxl.Workbook(write_only=<span class="literal">True</span>)</span><br><span class="line">    ws_report = workbook.create_sheet(<span class="string">&#x27;report&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> ws_report_tpl.rows:    </span><br><span class="line">        row_tpl = []</span><br><span class="line">        <span class="keyword">for</span> cell <span class="keyword">in</span> row:</span><br><span class="line">            cell_tpl = openpyxl.cell.WriteOnlyCell(ws_report)</span><br><span class="line">            cell_tpl.value = cell.value</span><br><span class="line">            cell_tpl.font = cell.font.copy()</span><br><span class="line">            cell_tpl.fill = cell.fill.copy()</span><br><span class="line">            row_tpl.append(cell_tpl)</span><br><span class="line">        ws_report.append(row_tpl)</span><br><span class="line">    <span class="keyword">for</span> idx_row, row <span class="keyword">in</span> df_output_db.iterrows():</span><br><span class="line">        <span class="keyword">if</span> idx_row % <span class="number">10000</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(indx_row)</span><br><span class="line">        ws_report.append(row.to_list())</span><br><span class="line">    workbook.save(report)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_time = datetime.now()</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;query data from db&#x27;</span>)</span><br><span class="line">    df_output_db = query_data_from_db(conn)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;large data&#x27;</span>)</span><br><span class="line">    df_output_db = large_data(df_output_db)</span><br><span class="line">    df_output_db = df_output_db.reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    logger_info(<span class="string">f&#x27;count data:<span class="subst">&#123;<span class="built_in">len</span>(df_output_db)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">&#x27;write to excel&#x27;</span>)</span><br><span class="line">    start_time_excel = datetime.now()</span><br><span class="line">    write_to_excel(<span class="string">&#x27;template.xlsx&#x27;</span>, <span class="string">&#x27;report.xlsx&#x27;</span>)</span><br><span class="line">    logger_info(<span class="string">f&#x27;write to excel cost time:<span class="subst">&#123;datetime.now() - start_time_excel&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    logger_info(<span class="string">f&#x27;cost time:<span class="subst">&#123;datetime.now()-start_time&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\GitSpace\PowerScript\Python3\openpyxl\generate_report&gt; python .\generate_report.hugedata.writeonly.py</span><br><span class="line">2019-11-10 10:54:58.253268[INFO] query data from db</span><br><span class="line">2019-11-10 10:54:58.255265[INFO] large data</span><br><span class="line">2019-11-10 10:54:58.292595[INFO] count data:131072</span><br><span class="line">2019-11-10 10:54:58.292595[INFO] write to excel</span><br><span class="line">2019-11-10 10:55:18.039439[INFO] write to excel cost time:0:00:19.745817</span><br><span class="line">2019-11-10 10:55:18.039439[INFO] cost time:0:00:19.786171</span><br></pre></td></tr></table></figure>

<p>可以看到时间上普通用法比 write_only 慢了 36%左右，在数据量大的时候更明显，内存上的消耗更不用说。</p>
<p>完整的代码在<a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/tree/master/Python3/openpyxl/generate_report">demo04_compare_csv</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-01-19T16:00:00.000Z" title="2019/1/20 上午12:00:00">2019-01-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-09-08T15:43:26.401Z" title="2020/9/8 下午11:43:26">2020-09-08</time></span><span class="level-item"> BF </span><span class="level-item">5 minutes read (About 808 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/20/2019/01/2019-01-20-CompareExcel/">Compare Excel</a></h1><div class="content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>下周可能有一个小任务是由于系统升级，需要保证生成的 excel 是一致的，所以写了一个非常简单的对比脚本。</p>
<h1 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h1><p>下面直接上代码，主要的思路就是从上到下依次对比，从 sheet name 开始，最后对比 cell 的值，数据类型，数据格式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># author: xiche</span></span><br><span class="line"><span class="comment"># create at: 01/20/2019</span></span><br><span class="line"><span class="comment"># description:</span></span><br><span class="line"><span class="comment">#     simple script to compare excel</span></span><br><span class="line"><span class="comment"># Change log:</span></span><br><span class="line"><span class="comment"># Date          Author      Version     Description</span></span><br><span class="line"><span class="comment"># 01/20/2019    xiche       1.0         init</span></span><br><span class="line"><span class="comment"># 01/21/2019    xiche       1.1         add compare csvs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> openpyxl</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_cell</span>(<span class="params">cell01, cell02</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(cell01.value != cell02.value):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;&#123;&#125;: &#123;&#125; / &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cell01.column,</span><br><span class="line">                                     cell01.row, cell01.value, cell02.value))</span><br><span class="line">    <span class="keyword">elif</span>(cell01.data_type != cell02.data_type):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;&#123;&#125;: &#123;&#125; / &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cell01.column,</span><br><span class="line">                                     cell01.row, cell01.data_type, cell02.data_type))</span><br><span class="line">    <span class="keyword">elif</span>(cell01.number_format != cell02.number_format):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;&#123;&#125;: &#123;&#125; / &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cell01.column, cell01.row,</span><br><span class="line">                                     cell01.number_format, cell02.number_format))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_sheet</span>(<span class="params">sheet01, sheet02</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sheet01.max_row != sheet02.max_row):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;row is not matched! &#123;&#125; / &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(sheet01.max_row, sheet02.max_row))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sheet01.max_column != sheet02.max_column):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;column is not matched! &#123;&#125; / &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(sheet01.max_column,</span><br><span class="line">                                                      sheet02.max_column))</span><br><span class="line"></span><br><span class="line">    max_row = <span class="built_in">max</span>(sheet01.max_row, sheet02.max_row)</span><br><span class="line">    max_column = <span class="built_in">max</span>(sheet01.max_column, sheet02.max_column)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index_row <span class="keyword">in</span> <span class="built_in">range</span>(max_row):</span><br><span class="line">        <span class="keyword">for</span> index_col <span class="keyword">in</span> <span class="built_in">range</span>(max_column):</span><br><span class="line">            compare_cell(sheet01.cell(column=index_col+<span class="number">1</span>, row=index_row+<span class="number">1</span>),</span><br><span class="line">                         sheet02.cell(column=index_col+<span class="number">1</span>, row=index_row+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_excels</span>(<span class="params">excel_file01, excel_file02</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;------compare &#123;&#125; &amp; &#123;&#125;------&#x27;</span>.<span class="built_in">format</span>(excel_file01, excel_file02))</span><br><span class="line">    wb01 = openpyxl.load_workbook(excel_file01)</span><br><span class="line">    wb02 = openpyxl.load_workbook(excel_file02)</span><br><span class="line"></span><br><span class="line">    sheet_names_01 = wb01.get_sheet_names()</span><br><span class="line">    sheet_names_02 = wb02.get_sheet_names()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(sheet_names_01) != <span class="built_in">len</span>(sheet_names_02)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;sheets number are not matched!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sheet_names_01)):</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(sheet_names_01[i]) != <span class="built_in">len</span>(sheet_names_02[i])):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;sheets name not matched!\n&#123;&#125;:&#123;&#125; / &#123;&#125;:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(excel_file01,</span><br><span class="line">                                                                   sheet_names_01[i], excel_file02, sheet_names_02[i]))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        sheet01 = wb01.get_sheet_by_name(sheet_names_01[i])</span><br><span class="line">        sheet02 = wb02.get_sheet_by_name(sheet_names_02[i])</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;compare &#123;&#125;:&#123;&#125; &amp; &#123;&#125;:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(excel_file01,</span><br><span class="line">                                             sheet01.title, excel_file02, sheet02.title))</span><br><span class="line">        compare_sheet(sheet01, sheet02)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_csv</span>(<span class="params">csv_file01, csv_file02</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;------compare &#123;&#125; &amp; &#123;&#125;------&#x27;</span>.<span class="built_in">format</span>(csv_file01, csv_file02))</span><br><span class="line">    is_diff = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(csv_file01, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> csv_01, <span class="built_in">open</span>(csv_file02, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> csv_02:</span><br><span class="line">        csv_reader_01 = csv.reader(csv_01, delimiter=<span class="string">&#x27;,&#x27;</span>, quotechar=<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">        csv_reader_02 = csv.reader(csv_02, delimiter=<span class="string">&#x27;,&#x27;</span>, quotechar=<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">        csv_list_01 = <span class="built_in">list</span>(csv_reader_01)</span><br><span class="line">        csv_list_02 = <span class="built_in">list</span>(csv_reader_02)</span><br><span class="line">        ccsv_list_02_copy = copy.deepcopy(csv_list_02)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> csv_list_01:</span><br><span class="line">            <span class="keyword">if</span> line <span class="keyword">not</span> <span class="keyword">in</span> csv_list_02:</span><br><span class="line">                is_diff = <span class="literal">True</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(csv_file01, line))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ccsv_list_02_copy.remove(line)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> ccsv_list_02_copy:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(csv_file02, line))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_diff:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;No difference between these two csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Compare-Excel"><a href="#Compare-Excel" class="headerlink" title="Compare Excel"></a>Compare Excel</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    compare_excels(<span class="string">&#x27;test01.xlsx&#x27;</span>, <span class="string">&#x27;test01.copy.xlsx&#x27;</span>)</span><br><span class="line">    compare_excels(<span class="string">&#x27;test01.xlsx&#x27;</span>, <span class="string">&#x27;test02.xlsx&#x27;</span>)</span><br><span class="line">    compare_excels(<span class="string">&#x27;test01.xlsx&#x27;</span>, <span class="string">&#x27;test03.xlsx&#x27;</span>)</span><br><span class="line">    compare_excels(<span class="string">&#x27;test01.xlsx&#x27;</span>, <span class="string">&#x27;test04.xlsx&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>目前的输出结果如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\mayn\Desktop\GitSpace\PowerScript\Python3\openpyxl\compare_excels&gt;python compare_excels.py</span><br><span class="line">-----<span class="literal">-compare</span> test01.xlsx &amp; test01.copy.xlsx------</span><br><span class="line"><span class="built_in">compare</span> test01.xlsx:Sheet1 &amp; test01.copy.xlsx:Sheet1</span><br><span class="line">-----<span class="literal">-compare</span> test01.xlsx &amp; test02.xlsx------</span><br><span class="line"><span class="built_in">compare</span> test01.xlsx:Sheet1 &amp; test02.xlsx:Sheet1</span><br><span class="line">row is not matched! <span class="number">4</span> / <span class="number">5</span></span><br><span class="line">B2: mm<span class="literal">-dd</span><span class="literal">-yy</span> / [<span class="variable">$</span>-<span class="number">409</span>]d\<span class="literal">-mmm</span>\<span class="literal">-yy</span>;<span class="selector-tag">@</span></span><br><span class="line">C4: Test03 / Test04</span><br><span class="line">B5: None / <span class="number">10</span>/<span class="number">21</span>/<span class="number">2010</span></span><br><span class="line">C5: None / Test05</span><br><span class="line">-----<span class="literal">-compare</span> test01.xlsx &amp; test03.xlsx------</span><br><span class="line">sheets name not matched!</span><br><span class="line">test01.xlsx:Sheet1 / test03.xlsx:NotMatch</span><br><span class="line">-----<span class="literal">-compare</span> test01.xlsx &amp; test04.xlsx------</span><br><span class="line"><span class="built_in">compare</span> test01.xlsx:Sheet1 &amp; test04.xlsx:sheet1</span><br><span class="line">row is not matched! <span class="number">4</span> / <span class="number">6</span></span><br><span class="line">column is not matched! <span class="number">3</span> / <span class="number">4</span></span><br><span class="line">B2: mm<span class="literal">-dd</span><span class="literal">-yy</span> / [<span class="variable">$</span>-<span class="number">409</span>]d\<span class="literal">-mmm</span>\<span class="literal">-yy</span>;<span class="selector-tag">@</span></span><br><span class="line">C4: Test03 / Test04</span><br><span class="line">B5: None / <span class="number">10</span>/<span class="number">21</span>/<span class="number">2010</span></span><br><span class="line">C5: None / Test05</span><br><span class="line">B6: None / test</span><br><span class="line">C6: None / test</span><br><span class="line">D6: None / test</span><br></pre></td></tr></table></figure>

<h1 id="Compare-CSV"><a href="#Compare-CSV" class="headerlink" title="Compare CSV"></a>Compare CSV</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    compare_csv(<span class="string">&#x27;demo01.csv&#x27;</span>, <span class="string">&#x27;demo01.copy.csv&#x27;</span>)</span><br><span class="line">    compare_csv(<span class="string">&#x27;demo01.csv&#x27;</span>, <span class="string">&#x27;demo02.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>demo01.csv</code>和<code>demo02.csv</code>有两行数据不一值：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c:\Users\mayn\Desktop\GitSpace\PowerScript\Python3\openpyxl\compare_excels&gt;python compare_excels.py</span><br><span class="line">-----<span class="literal">-compare</span> demo01.csv &amp; demo01.copy.csv------</span><br><span class="line">No difference between these two csv</span><br><span class="line">-----<span class="literal">-compare</span> demo01.csv &amp; demo02.csv------</span><br><span class="line">demo01.csv:[<span class="string">&#x27;R1&#x27;</span>, <span class="string">&#x27; R1&#x27;</span>, <span class="string">&#x27; R1&#x27;</span>]</span><br><span class="line">demo02.csv:[<span class="string">&#x27;Z5&#x27;</span>, <span class="string">&#x27; R4&#x27;</span>, <span class="string">&#x27; R4&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>不知道有没有第三方库直接提供对比的方法，自己的这个之后可以添加到自己的工具库中。</p>
<p>代码和测试的文件在：<a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/tree/master/Python3/openpyxl/compare_excels">compare_excels</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-06-17T16:00:00.000Z" title="2018/6/18 上午12:00:00">2018-06-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-10-18T13:45:48.446Z" title="2018/10/18 下午9:45:48">2018-10-18</time></span><span class="level-item"> BF </span><span class="level-item">5 minutes read (About 677 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/06/18/2018/06/2018-06-18-CreateLineChartByOpenpyxl/">Create Excel with line chart by openpyxl</a></h1><div class="content"><h1 id="Create-Excel-with-line-chart-by-openpyxl"><a href="#Create-Excel-with-line-chart-by-openpyxl" class="headerlink" title="Create Excel with line chart by openpyxl"></a>Create Excel with line chart by openpyxl</h1><p>之前有用过<code>openpyxl</code>做了<a href="https://bearfly1990.github.io/2018/04/24/openpyxl/">简单的介绍</a>。</p>
<p>但是我今天在尝试画chart的时候，发现没有很好用的api可以参考，可能是我没找到吧，一些细节只能google，或者从源代码里找。</p>
<p>好在之前在做AMS报表的时候，有用ChartFX画过一些图表，大体上的api设计是一致的。</p>
<h2 id="需求-amp-背景"><a href="#需求-amp-背景" class="headerlink" title="需求&amp;背景"></a>需求&amp;背景</h2><p>现在多虚拟机连续性能测试已经搭好了，当时自己给自己定了一个optional的目标，就是把最后的log也可视化，比如以总结的excel来展现。</p>
<p>这样就可以省去人工处理的时间，不然每次都要自己打开csv，add chart还是有点麻烦，如果直接打开excel就能看到图还是很爽的。</p>
<p>当然，今天只是完成了第一步，之后有需要和时间的话，再把其它test result整合进来。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>任务很简单，就是把下面的csv转成excle并画图。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Time,CPU(%),Memory(%)</span><br><span class="line">2018&#x2F;06&#x2F;17 23:47:11,17.0,16.71</span><br><span class="line">2018&#x2F;06&#x2F;17 23:47:13,1.5,17.01</span><br><span class="line">2018&#x2F;06&#x2F;17 23:47:15,2.9,17.04</span><br><span class="line">2018&#x2F;06&#x2F;17 23:47:17,23.6,17.22</span><br><span class="line">2018&#x2F;06&#x2F;17 23:47:19,27.0,18.54</span><br></pre></td></tr></table></figure>
<p>下面直接上代码，主要用了<code>openpyxl</code>.</p>
<p>像<code>lib.cmutils_io</code>这种是我自己写的类库，比如CSVUtils就是我用标准库<code>csv</code>封装了一些常用的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> openpyxl</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> lib.cmutils_io <span class="keyword">import</span> CSVUtils</span><br><span class="line"><span class="keyword">from</span> openpyxl.chart <span class="keyword">import</span> (</span><br><span class="line">    LineChart,</span><br><span class="line">    Reference,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> openpyxl.chart.axis <span class="keyword">import</span> DateAxis</span><br><span class="line"><span class="keyword">from</span> openpyxl <span class="keyword">import</span> Workbook</span><br><span class="line">DATE_TIME_FORMAT = <span class="string">&quot;%Y/%m/%d %H:%M:%S&quot;</span> <span class="comment">#&quot;2018-06-13 23:51:17&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_monitor</span>():</span></span><br><span class="line">    wb_tpl = Workbook()</span><br><span class="line">    ws = wb_tpl.active</span><br><span class="line">    <span class="comment"># ws = wb_tpl.worksheets[0]</span></span><br><span class="line">    ws.title = <span class="string">&quot;Monitor&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">        [2018/06/17 23:47:11,17.0,16.71],</span></span><br><span class="line"><span class="string">        [2018/06/17 23:47:13,1.5,17.01],</span></span><br><span class="line"><span class="string">        [2018/06/17 23:47:15,2.9,17.04],</span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data_list = CSVUtils.readCSVRowsList(<span class="string">&quot;Monitor.csv&quot;</span>)</span><br><span class="line">    _max_row = <span class="built_in">len</span>(data_list)</span><br><span class="line">    _max_col = <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> row_index, rows <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_list):</span><br><span class="line">        <span class="keyword">for</span> col_index, value <span class="keyword">in</span> <span class="built_in">enumerate</span>(rows):</span><br><span class="line">            <span class="keyword">if</span>(row_index == <span class="number">0</span>):</span><br><span class="line">                ws.cell(row=row_index+<span class="number">1</span>, column=col_index+<span class="number">1</span>).value = value</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span>(col_index == <span class="number">0</span>):</span><br><span class="line">                    ws.cell(row=row_index+<span class="number">1</span>, column=col_index+<span class="number">1</span>).value = datetime.strptime(value, DATE_TIME_FORMAT)</span><br><span class="line">                    ws.cell(row=row_index+<span class="number">1</span>, column=col_index+<span class="number">1</span>).number_format = <span class="string">&#x27;HH:mm:ss&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ws.cell(row=row_index+<span class="number">1</span>, column=col_index+<span class="number">1</span>).value = <span class="built_in">float</span>(value)</span><br><span class="line">    chart1 = LineChart()</span><br><span class="line">    chart1.title = <span class="string">&quot;CPU/Memory Mornitor&quot;</span></span><br><span class="line">    chart1.style = <span class="number">2</span> <span class="comment"># default style when new a line chart</span></span><br><span class="line">    chart1.height = <span class="number">15</span> <span class="comment"># default is 7.5</span></span><br><span class="line">    chart1.width = <span class="number">30</span> <span class="comment"># default is 15</span></span><br><span class="line">    chart1.legend.position = <span class="string">&quot;b&quot;</span></span><br><span class="line">    chart1.y_axis.scaling.<span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">    chart1.y_axis.scaling.<span class="built_in">max</span> = <span class="number">100</span></span><br><span class="line">    <span class="comment"># chart1.y_axis.title = &#x27;Pecent&#x27;</span></span><br><span class="line">    <span class="comment"># chart1.x_axis.title = &#x27;Time&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># set y-axis</span></span><br><span class="line">    data = Reference(ws, min_col=<span class="number">2</span>, min_row=<span class="number">1</span>, max_col=_max_col, max_row=_max_row)</span><br><span class="line">    chart1.add_data(data, titles_from_data=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set time as category(x-axis)</span></span><br><span class="line">    cats = Reference(ws, min_col=<span class="number">1</span>, min_row=<span class="number">1</span>, max_row=_max_row)</span><br><span class="line">    chart1.set_categories(cats)    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Style the lines</span></span><br><span class="line">    <span class="comment"># s1 = c1.series[0]</span></span><br><span class="line">    <span class="comment"># s1.marker.symbol = &quot;triangle&quot;</span></span><br><span class="line">    <span class="comment"># s1.marker.graphicalProperties.solidFill = &quot;FF0000&quot; # Marker filling</span></span><br><span class="line">    <span class="comment"># s1.marker.graphicalProperties.line.solidFill = &quot;FF0000&quot; # Marker outline</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># s1.graphicalProperties.line.noFill = True</span></span><br><span class="line"></span><br><span class="line">    s2 = chart1.series[<span class="number">0</span>]</span><br><span class="line">    s2.smooth = <span class="literal">True</span> <span class="comment"># Make the line smooth</span></span><br><span class="line">    <span class="comment"># s2.graphicalProperties.line.solidFill = &quot;00AAAA&quot;</span></span><br><span class="line">    <span class="comment"># s2.graphicalProperties.line.dashStyle = &quot;sysDot&quot;</span></span><br><span class="line">    <span class="comment"># s2.graphicalProperties.line.width = 100050 # width in EMUs</span></span><br><span class="line"></span><br><span class="line">    s2 = chart1.series[<span class="number">1</span>]</span><br><span class="line">    s2.smooth = <span class="literal">True</span> <span class="comment"># Make the line smooth</span></span><br><span class="line">    <span class="comment"># chart1.x_axis.tickLblPos = &quot;low&quot;</span></span><br><span class="line">    <span class="comment"># chart1.x_axis.tickLblSkip = 3 # whatever you like</span></span><br><span class="line">    ws.add_chart(chart1, <span class="string">&quot;F10&quot;</span>)</span><br><span class="line">   </span><br><span class="line">            </span><br><span class="line">    dest_filename = <span class="string">&#x27;test2.xlsx&#x27;</span></span><br><span class="line">    wb_tpl.save(filename = dest_filename)</span><br><span class="line">   </span><br><span class="line">test_monitor()</span><br></pre></td></tr></table></figure>
<h3 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续:)"></a>未完待续:)</h3></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-04-23T16:00:00.000Z" title="2018/4/24 上午12:00:00">2018-04-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-30T15:46:40.248Z" title="2018/11/30 下午11:46:40">2018-11-30</time></span><span class="level-item"> BF </span><span class="level-item">4 minutes read (About 644 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/24/2018/04/2018-04-24-openpyxl/">openpyxl</a></h1><div class="content"><h2 id="openpyxl"><a href="#openpyxl" class="headerlink" title="openpyxl"></a>openpyxl</h2><p>之前测试PamReport的报表，需要对比txt和excel报表，用java(<a target="_blank" rel="noopener" href="https://poi.apache.org/">org.apache.poi</a>)写了对比的脚本。但感觉还是有些麻烦，<br>java在文本io方面还是不够灵活方便。今天试了python的openpyxl这个库，感觉真的的特别好用，就试着用了一下基本操作。</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>我当时简单写了一个ExcelUtils，下面是取单元格数据的一个方法，感受一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCellString</span><span class="params">(String cellStr)</span></span>&#123;</span><br><span class="line">     String result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">     CellReference cellReference = <span class="keyword">new</span> CellReference(cellStr); </span><br><span class="line">     Row row     = curSheet.getRow(cellReference.getRow());</span><br><span class="line">     Cell cell   = row.getCell(cellReference.getCol());</span><br><span class="line">     <span class="keyword">switch</span> (cell.getCellTypeEnum()) &#123;</span><br><span class="line">         <span class="keyword">case</span> NUMERIC:</span><br><span class="line">             result = Double.toString(cell.getNumericCellValue());</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> STRING:</span><br><span class="line">             result = cell.getStringCellValue();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> FORMULA:</span><br><span class="line">             result = cell.getCellFormula();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> BLANK:</span><br><span class="line">             result = cell.getStringCellValue();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">             result = Boolean.toString(cell.getBooleanCellValue());</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             result = cell.getStringCellValue();</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="openpyxl-1"><a href="#openpyxl-1" class="headerlink" title="openpyxl"></a>openpyxl</h3><h4 id="新建文档-New-Excel-File"><a href="#新建文档-New-Excel-File" class="headerlink" title="新建文档 New Excel File"></a>新建文档 New Excel File</h4><p>创建一个新的excel，将默认的<code>Sheet1</code>改为<code>salary</code>,新建sheet <code>Pi</code>然后保存。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wb = Workbook()</span><br><span class="line">dest_filename = <span class="string">&#x27;test.xlsx&#x27;</span></span><br><span class="line">ws1 = wb.active</span><br><span class="line">ws1.title = <span class="string">&quot;salary&quot;</span></span><br><span class="line">ws2 = wb.create_sheet(title=<span class="string">&quot;Pi&quot;</span>)</span><br><span class="line">wb.save(filename = dest_filename)</span><br></pre></td></tr></table></figure>

<h4 id="常用赋值-Common-Usage"><a href="#常用赋值-Common-Usage" class="headerlink" title="常用赋值 Common Usage"></a>常用赋值 Common Usage</h4><h5 id="字符串，数值-string-number"><a href="#字符串，数值-string-number" class="headerlink" title="字符串，数值 string, number"></a>字符串，数值 string, number</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ws1[<span class="string">&#x27;A1&#x27;</span>] = <span class="string">&#x27;id&#x27;</span></span><br><span class="line">ws1[<span class="string">&#x27;B1&#x27;</span>] = <span class="string">&#x27;name&#x27;</span></span><br><span class="line">ws1[<span class="string">&#x27;C1&#x27;</span>] = <span class="string">&#x27;salary&#x27;</span></span><br><span class="line">ws1[<span class="string">&#x27;A2&#x27;</span>] = <span class="number">1</span></span><br><span class="line">ws1[<span class="string">&#x27;B2&#x27;</span>] = <span class="string">&#x27;xiche&#x27;</span></span><br><span class="line">ws1[<span class="string">&#x27;C2&#x27;</span>] = <span class="number">9999</span></span><br></pre></td></tr></table></figure>

<h5 id="时间类型-datetime"><a href="#时间类型-datetime" class="headerlink" title="时间类型 datetime"></a>时间类型 datetime</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ws1[<span class="string">&#x27;A3&#x27;</span>] = datetime.datetime(<span class="number">2010</span>, <span class="number">7</span>, <span class="number">21</span>)</span><br><span class="line"><span class="built_in">print</span>(ws1[<span class="string">&#x27;A1&#x27;</span>].number_format)</span><br></pre></td></tr></table></figure>

<h5 id="数值格式化-number-format"><a href="#数值格式化-number-format" class="headerlink" title="数值格式化 number format"></a>数值格式化 number format</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wb.guess_types = <span class="literal">True</span></span><br><span class="line">ws1[<span class="string">&#x27;B3&#x27;</span>] = <span class="string">&#x27;3.14%&#x27;</span></span><br><span class="line">wb.guess_types = <span class="literal">False</span></span><br><span class="line"><span class="built_in">print</span>(ws1[<span class="string">&#x27;B3&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(ws1[<span class="string">&#x27;B3&#x27;</span>].number_format)</span><br></pre></td></tr></table></figure>

<h5 id="公式-formula"><a href="#公式-formula" class="headerlink" title="公式 formula"></a>公式 formula</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws1[<span class="string">&quot;A4&quot;</span>] = <span class="string">&quot;=SUM(1, 1)&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="合并单元格-merge-cells"><a href="#合并单元格-merge-cells" class="headerlink" title="合并单元格 merge cells"></a>合并单元格 merge cells</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws1.merge_cells(<span class="string">&#x27;A5:E5&#x27;</span>)</span><br><span class="line">ws1.merge_cells(<span class="string">&#x27;A6:E7&#x27;</span>)</span><br><span class="line">ws1.unmerge_cells(<span class="string">&#x27;A6:E7&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="插入图像-image"><a href="#插入图像-image" class="headerlink" title="插入图像 image"></a>插入图像 image</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image = Image(<span class="string">&#x27;logo.png&#x27;</span>)</span><br><span class="line">ws1.add_image(img, <span class="string">&#x27;C1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最后生成的excel的效果：</p>
<p><img src="/img/post/2018/04/2018-04-24-openpyxl_1.jpg" alt="sheet salary"></p>
<h4 id="读取文档-Read-Excel-File"><a href="#读取文档-Read-Excel-File" class="headerlink" title="读取文档 (Read Excel File)"></a>读取文档 (Read Excel File)</h4><h5 id="读取worksheet"><a href="#读取worksheet" class="headerlink" title="读取worksheet"></a>读取worksheet</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wb = openpyxl.load_workbook(<span class="string">&#x27;test.xlsx&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(wb))</span><br><span class="line"><span class="built_in">print</span>(wb.sheetnames)</span><br><span class="line"><span class="built_in">print</span>(wb[<span class="string">&#x27;salary&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h5 id="获取title-sheet-name"><a href="#获取title-sheet-name" class="headerlink" title="获取title (sheet name)"></a>获取title (sheet name)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sheet_salary = wb[<span class="string">&#x27;salary&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;title:%s&quot;</span> % sheet_salary.title)</span><br></pre></td></tr></table></figure>
<h5 id="获取单元格的方式-get-cells-and-its-value"><a href="#获取单元格的方式-get-cells-and-its-value" class="headerlink" title="获取单元格的方式 get cells and its value"></a>获取单元格的方式 get cells and its value</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;A1:%s B1:%s C1:%s&quot;</span> % (sheet_salary[<span class="string">&#x27;A1&#x27;</span>].value, sheet_salary[<span class="string">&#x27;B1&#x27;</span>].value, sheet_salary[<span class="string">&#x27;C1&#x27;</span>].value))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;A2:%s B2:%s C2:%s&quot;</span> % (sheet_salary[<span class="string">&#x27;A2&#x27;</span>].value, sheet_salary[<span class="string">&#x27;B2&#x27;</span>].value, sheet_salary[<span class="string">&#x27;C2&#x27;</span>].value))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;A3:%s B3:%s C3:%s&quot;</span> % (sheet_salary[<span class="string">&#x27;A3&#x27;</span>].value, sheet_salary[<span class="string">&#x27;B3&#x27;</span>].value, sheet_salary[<span class="string">&#x27;C3&#x27;</span>].value))</span><br><span class="line"></span><br><span class="line">cell_A1 = sheet_salary.cell(column = <span class="number">1</span>, row = <span class="number">1</span>)</span><br><span class="line">cell_A2 = sheet_salary.cell(column = <span class="number">1</span>, row = <span class="number">2</span>)</span><br><span class="line">cell_B1 = sheet_salary.cell(column = <span class="number">2</span>, row = <span class="number">1</span>)</span><br><span class="line">cell_B2 = sheet_salary.cell(column = <span class="number">2</span>, row = <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;A1:%s B1:%s&quot;</span> % (cell_A1.value, cell_B1.value))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;A2:%s B3:%s&quot;</span> % (cell_A2.value, cell_B2.value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>):</span><br><span class="line">        columnChar = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>)+j)</span><br><span class="line">        rowNum = i</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s%s:%s&quot;</span> % (columnChar, rowNum, sheet_salary[columnChar+<span class="built_in">str</span>(rowNum)].value))</span><br></pre></td></tr></table></figure>
<h5 id="获取sheet已使用的最大范围-max-row-column"><a href="#获取sheet已使用的最大范围-max-row-column" class="headerlink" title="获取sheet已使用的最大范围 max row/column"></a>获取sheet已使用的最大范围 max row/column</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;max_row:%s&quot;</span> % sheet_salary.max_row)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;max_column:%s&quot;</span> % sheet_salary.max_column)</span><br></pre></td></tr></table></figure>
<p>更具体的信息参考：<a target="_blank" rel="noopener" href="https://openpyxl.readthedocs.io/en/stable/">openpyxl官网</a></p>
<p>我的demo：<a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/blob/master/Python3/openpyxl/demo.py">demo.py</a></p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mybear.jpg" alt="bearfly1990"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">bearfly1990</p><p class="is-size-6 is-block">有熊在飞</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>HZ, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">100</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/bearfly1990" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/bearfly1990"><i class="fab fa-github"></i></a></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.ico" alt="BF Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 bearfly1990</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>