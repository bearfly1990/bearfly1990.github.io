<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Tag: python - BF Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="BF Blog"><meta name="msapplication-TileImage" content="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="BF Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="BF Blog"><meta property="og:url" content="https://bearfly1990.github.io/"><meta property="og:site_name" content="BF Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://bearfly1990.github.io/img/og_image.png"><meta property="article:author" content="bearfly1990"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bearfly1990.github.io"},"headline":"BF Blog","image":["https://bearfly1990.github.io/img/og_image.png"],"author":{"@type":"Person","name":"bearfly1990"},"publisher":{"@type":"Organization","name":"BF Blog","logo":{"@type":"ImageObject","url":"https://bearfly1990.github.io/img/favicon.ico"}},"description":""}</script><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.ico" alt="BF Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bearfly1990"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">python</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-12-10T16:00:00.000Z" title="2018/12/11 上午12:00:00">2018-12-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-09-08T15:43:26.390Z" title="2020/9/8 下午11:43:26">2020-09-08</time></span><span class="level-item"> BF </span><span class="level-item">4 minutes read (About 533 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/12/11/2018/12/2018-12-11-PythonThreadLock/">Python Thread Lock</a></h1><div class="content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>这两天在继续修改之前写的测试脚本。这两天想要实现并发跑一些任务，之后还要把结果写要 testresult.csv 中。</p>
<p>这样的话就涉及一个问题，因为是并发跑的，所以可以会出现资源争抢的问题，那么就需要对读写加锁控制。</p>
<p>在网上查了下，发现有第三方文件锁库 fcntl 可以使用，不过可惜的是<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/unix.html">Unix Specific</a></p>
<p>所以最直接的还是用线程锁来解决这个问题</p>
<h1 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h1><p>在 threading 模块中定义了 Lock 类，可以方便的处理锁定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create lock</span></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"><span class="comment"># acquire lock</span></span><br><span class="line">mutex.acquire([timeout])</span><br><span class="line"><span class="comment"># release lock</span></span><br><span class="line">mutex.release()</span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>下面是我写的简单的例子，模拟了实际的情况，每个 job 跑完的时间是不一定的，当他们想要写测试结果文件中写数据的时候要先去获得锁。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job_running</span>():</span></span><br><span class="line">    time.sleep(random.randint(<span class="number">1</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_result</span>(<span class="params">txt_file, thread_name</span>):</span></span><br><span class="line">    mutex.acquire(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(txt_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Thread &#123;0&#125; acquire lock&quot;</span>.<span class="built_in">format</span>(thread_name))</span><br><span class="line">        f.write(<span class="string">&quot;write from thread &#123;0&#125; \r\n&quot;</span>.<span class="built_in">format</span>(thread_name))</span><br><span class="line">        time.sleep(random.randint(<span class="number">1</span>,<span class="number">3</span>))</span><br><span class="line">    mutex.release()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Thread &#123;0&#125; exit&quot;</span>.<span class="built_in">format</span>(thread_name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_job</span>(<span class="params">txt_file</span>):</span></span><br><span class="line">    thread_name = threading.currentThread().getName()</span><br><span class="line">    job_running()</span><br><span class="line">    write_result(txt_file, thread_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        myThread = threading.Thread(target=run_job, args=(<span class="string">&quot;testResult.txt&quot;</span>,))</span><br><span class="line">        myThread.start()</span><br></pre></td></tr></table></figure>

<p>运行的结果，和预期的效果一样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\workspace\python_file_lock&gt; python .\file_lock_demo.py</span><br><span class="line">Thread Thread-3 acquire lock</span><br><span class="line">Thread Thread-3 exit</span><br><span class="line">Thread Thread-5 acquire lock</span><br><span class="line">Thread Thread-5 exit</span><br><span class="line">Thread Thread-2 acquire lock</span><br><span class="line">Thread Thread-2 exit</span><br><span class="line">Thread Thread-1 acquire lock</span><br><span class="line">Thread Thread-1 exit</span><br><span class="line">Thread Thread-4 acquire lock</span><br><span class="line">Thread Thread-4 exit</span><br></pre></td></tr></table></figure>

<h1 id="使用fcntl"><a href="#使用fcntl" class="headerlink" title="使用fcntl"></a>使用fcntl</h1><p>因为在Windows下无法使用，自己也没去尝试，有兴趣可以通过最后参考中的链接去了解。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>多线程是个可以探究的很深的问题，还有许多的知识点需要继续学习，遇到问题一定要深究一下。</p>
<hr>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30554229/article/details/80094253">Python 多线程读写文件加锁</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011734144/article/details/78739442">Python 的文件锁使用</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-12-07T16:00:00.000Z" title="2018/12/8 上午12:00:00">2018-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-09-08T15:43:26.389Z" title="2020/9/8 下午11:43:26">2020-09-08</time></span><span class="level-item"> BF </span><span class="level-item">5 minutes read (About 824 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/12/08/2018/12/2018-12-08-TestResultDBImplement/">Test Result DB Implement</a></h1><div class="content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>上周提到想要把测试的结果保存到数据库中，下面主要介绍实现的思路。</p>
<p>注意：在定义表名和字段的时候，最好使用小写开头，我下面的例子并不规范。</p>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>最后的数据表结构设计成大致如下：<br><img src="/img/post/2018/12/2018-12-08-TestResultDBDesign.svg" alt="TestResultDBDesign"></p>
<h1 id="sqlalchemy"><a href="#sqlalchemy" class="headerlink" title="sqlalchemy"></a><a target="_blank" rel="noopener" href="https://www.sqlalchemy.org/">sqlalchemy</a></h1><p>在 Python 中，最有名的 ORM 框架是 SQLAlchemy，它能满足绝大多数对数据库的映射与操作。</p>
<p>网上有许多相关的资料，但是如果不翻墙的话，官网好像访问不了…</p>
<p>下面是使用到的一些类库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, DateTime, Float, String, create_engine, Integer, ForeignKey, exists, exc</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br></pre></td></tr></table></figure>

<h1 id="TestResult"><a href="#TestResult" class="headerlink" title="TestResult"></a>TestResult</h1><p>下面是对测试结果的 TestResult 表的映射，需要关联的是 TestDetail 那张表。</p>
<p>TestResult 是单次测试的总结记录，将测试的总体时间，测试的一些环境信息都保存下来，可以根据自己的需求扩充。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestResult</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;TestResult&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    TestTime = Column(DateTime)</span><br><span class="line">    TestVersion = Column(String(<span class="number">40</span>))</span><br><span class="line">    APPVersion = Column(String(<span class="number">100</span>))</span><br><span class="line">    Computer = Column(String(<span class="number">20</span>))</span><br><span class="line">    TotalTimeMinutes = Column(Float)</span><br><span class="line">    CPU = Column(String(<span class="number">20</span>))</span><br><span class="line">    Memory = Column(String(<span class="number">20</span>))</span><br><span class="line">    TestDetails = relationship(<span class="string">&#x27;TestDetail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="TestCase"><a href="#TestCase" class="headerlink" title="TestCase"></a>TestCase</h1><p>每一轮测试中，都会有分为不同的 Test Case，而在多次测试时，许多 Case 都是重复的，所以将相关的信息都保存在这个表中。</p>
<p>因为一般性能测试中，与数据条数有关，所以这边我加了一个 Rows，可以根据实际需求更改与添加字段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestCase</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;TestCase&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    TestCaseName = Column(String(<span class="number">50</span>))</span><br><span class="line">    Rows = Column(Integer)</span><br><span class="line">    TestDetails = relationship(<span class="string">&#x27;TestDetail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="TestDetail"><a href="#TestDetail" class="headerlink" title="TestDetail"></a>TestDetail</h1><p>每次测试中，具体的测试结果便存在 TestDetail 这张表中，针对 case 关注的信息不同，可以扩展相应的字段。</p>
<p>可以看到，我在这边建立了他与TestResult, TestCase的外键关联。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestDetail</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;TestDetail&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    CostTimeSeconds = Column(Float)</span><br><span class="line">    CostTimeMinutes = Column(Float)</span><br><span class="line">    TestResultID = Column(Integer, ForeignKey(<span class="string">&#x27;TestResult.id&#x27;</span>))</span><br><span class="line">    TestCaseID = Column(Integer, ForeignKey(<span class="string">&#x27;TestCase.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h1 id="TestUtils"><a href="#TestUtils" class="headerlink" title="TestUtils"></a>TestUtils</h1><p>下面是设计的一个操作类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestResultUtils</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, db_sqlnet=<span class="string">&#x27;xxx&#x27;</span>, db_name=<span class="string">&#x27;xxx&#x27;</span>, db_user=<span class="string">&#x27;xxx&#x27;</span>, db_password=<span class="string">&#x27;xxx&#x27;</span></span>):</span></span><br><span class="line">        self.engine = create_engine(<span class="string">&#x27;mssql+pymssql://&#123;0&#125;:&#123;1&#125;@&#123;2&#125;/&#123;3&#125;&#x27;</span>.<span class="built_in">format</span>(db_user, db_password, db_sqlnet, db_name))</span><br><span class="line">        DBSession = sessionmaker(bind=self.engine, autoflush=<span class="literal">False</span>)</span><br><span class="line">        self.session = DBSession()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_test_result</span>(<span class="params">self, test_result = <span class="literal">None</span>, test_case_list = [], test_detail_list = []</span>):</span></span><br><span class="line">        count = self.session.query(TestResult).<span class="built_in">filter</span>(TestResult.TestTime == test_result.TestTime).count()</span><br><span class="line">        <span class="keyword">if</span>(count &gt; <span class="number">0</span>):</span><br><span class="line">            test_result = self.session.query(TestResult).<span class="built_in">filter</span>(TestResult.TestTime == test_result.TestTime).first()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(test_case_list) != <span class="built_in">len</span>(test_detail_list)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;test case list and test detail list size is not matched.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> index, test_detail <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_detail_list):</span><br><span class="line">            test_case = test_case_list[index]</span><br><span class="line">            count = self.session.query(TestCase).<span class="built_in">filter</span>(TestCase.TestCaseName == test_case_list[index].TestCaseName <span class="keyword">and</span> TestCase.Rows == test_case_list[index].TestCaseName.Rows).count()</span><br><span class="line">            <span class="keyword">if</span>(count &gt; <span class="number">0</span>):</span><br><span class="line">                test_case = self.session.query(TestCase).<span class="built_in">filter</span>(TestCase.TestCaseName == test_case_list[index].TestCaseName <span class="keyword">and</span> TestCase.Rows == test_case_list[index].TestCaseName.Rows).first()</span><br><span class="line">            test_case_list[index] = test_case</span><br><span class="line">            test_case.TestDetails.append(test_detail)</span><br><span class="line">            test_result.TestDetails.append(test_detail)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> test_case <span class="keyword">in</span> test_case_list:</span><br><span class="line">            self.session.add(test_case)</span><br><span class="line">        self.session.add(test_result)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.session.commit()</span><br><span class="line">            self.session.close()</span><br><span class="line">        <span class="keyword">except</span> exc.SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(e))</span><br></pre></td></tr></table></figure>

<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>今天杭州的雪真的挺大的，晚安zzz</p>
<hr>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0014021031294178f993c85204e4d1b81ab032070641ce5000">使用 SQLAlchemy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/blob/master/Python3/mylib/cmutils_test.py">cmutils_test.py</a></li>
<li><a href="https://bearfly1990.github.io/2018/12/02/TestResultDBDesign/">DB for TestResult</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-11-25T16:00:00.000Z" title="2018/11/26 上午12:00:00">2018-11-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-26T16:30:53.539Z" title="2018/11/27 上午12:30:53">2018-11-27</time></span><span class="level-item"> BF </span><span class="level-item">14 minutes read (About 2061 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/26/2018/11/2018-11-26-PygRPC/">Python gRPC</a></h1><div class="content"><h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>RPC（Remote Procedure Call）—远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。RPC 协议假定某些传输协议的存在，如 TCP 或 UDP，为通信程序之间携带信息数据。在 OSI 网络通信模型中，RPC 跨越了传输层和应用层。RPC 使得开发包括网络分布式多程序在内的应用程序更加容易。</p>
<h2 id="RPC-架构"><a href="#RPC-架构" class="headerlink" title="RPC 架构"></a>RPC 架构</h2><p>先说说 RPC 服务的基本架构。一个完整的 RPC 架构里面包含了四个核心的组件，分别是 Client ,Server,Client Stub 以及 Server Stub，这个 Stub 可以理解为存根。分别说说这几个组件：</p>
<ul>
<li>客户端（Client），服务的调用方。</li>
<li>服务端（Server），真正的服务提供者。</li>
<li>客户端存根，存放服务端的地址消息，再将客户端的请求参数打包成网络消息，然后通过网络远程发送给服务方。</li>
<li>服务端存根，接收客户端发送过来的消息，将消息解包，并调用本地的方法。</li>
</ul>
<p>RPC 主要是用在大型企业里面，因为大型企业里面系统繁多，业务线复杂，而且效率优势非常重要的一块，这个时候 RPC 的优势就比较明显了。</p>
<p>项目一般使用 maven 来管理。比如一个处理订单的系统服务，先声明它的所有的接口（i.e. Java 中的 interface），然后将整个项目打包为一个 jar 包，服务端这边引入这个二方库，然后实现相应的功能，客户端这边也只需要引入这个二方库即可调用了。</p>
<p>为什么这么做？主要是为了减少客户端这边的 jar 包大小，因为每一次打包发布的时候，jar 包太多总是会影响效率。另外也是将客户端和服务端解耦，提高代码的可移植性。</p>
<h1 id="HTTP-and-RPC"><a href="#HTTP-and-RPC" class="headerlink" title="HTTP and RPC"></a>HTTP and RPC</h1><p>理论上来说 RPC 能实现的功能， 用 HTTP 也能实现，那它们的区别是什么？什么情况下使用 RPC？</p>
<p>他们最本质的区别是 RPC 主要是基于 TCP/IP 协议的，而 HTTP 服务主要是基于 HTTP 协议的，我们都知道 HTTP 协议是在传输层协议 TCP 之上的，所以效率上来看的话，RPC 是更优的。</p>
<h2 id="OSI-网络七层模型"><a href="#OSI-网络七层模型" class="headerlink" title="OSI 网络七层模型"></a>OSI 网络七层模型</h2><p>回顾一下 OSI 的七层网络结构模型（实际应用中基本上都是五层），它可以分为以下几层： （从上到下）</p>
<ul>
<li>第一层：应用层。定义了用于在网络中进行通信和传输数据的接口；</li>
<li>第二层：表示层。定义不同的系统中数据的传输格式，编码和解码规范等；</li>
<li>第三层：会话层。管理用户的会话，控制用户间逻辑连接的建立和中断；</li>
<li>第四层：传输层。管理着网络中的端到端的数据传输；</li>
<li>第五层：网络层。定义网络设备间如何传输数据；</li>
<li>第六层：链路层。将上面的网络层的数据包封装成数据帧，便于物理层传输；</li>
<li>第七层：物理层。这一层主要就是传输这些二进制数据。<br>实际应用过程中，五层协议结构里面是没有表示层和会话层的。应该说它们和应用层合并了。我们应该将重点放在应用层和传输层这两个层面。因为 HTTP 是应用层协议，而 TCP 是传输层协议。知道了网络的分层模型以后我们可以更好地理解为什么 RPC 服务相比 HTTP 服务要好一些！</li>
</ul>
<h1 id="RPC-流行框架"><a href="#RPC-流行框架" class="headerlink" title="RPC 流行框架"></a>RPC 流行框架</h1><p>Google 开源了 gRPC，Facebook 开源了 Thrift，Twitter 开源了 Finagle，百度开源了 bRPC，腾讯开源了 Tars，阿里开源了 Dubbo 和 HSF，新浪开源了 Motan 等，这些互联网公司在解决分布式高并发业务问题的同时，也向外界展示自己的技术实力。</p>
<ul>
<li><code>gRPC</code> 是 Google 公布的开源软件，基于最新的 HTTP2.0 协议，并支持常见的众多编程语言。 我们知道 HTTP2.0 是基于二进制的 HTTP 协议升级版本，目前各大浏览器都在快马加鞭的加以支持。 这个 RPC 框架是基于 HTTP 协议实现的，底层使用到了 Netty 框架的支持。</li>
<li><code>Thrift</code> 是 Facebook 的一个开源项目，主要是一个跨语言的服务开发框架。它有一个代码生成器来对它所定义的 IDL 定义文件自动生成服务代码框架。用户只要在其之前进行二次开发就行，对于底层的 RPC 通讯等都是透明的。不过这个对于用户来说的话需要学习特定领域语言这个特性，还是有一定成本的。</li>
<li><code>HSF</code> 全称为 High-Speed Service Framework，旨在为淘系的应用提供一个分布式的服务框架，HSF 从分布式应用层面以及统一的发布/调用方式层面为大家提供支持，从而可以很容易的开发分布式的应用以及提供或使用公用功能模块，而不用考虑分布式领域中的各种细节技术，例如远程通讯、性能损耗、调用的透明化、同步/异步调用方式的实现等等问题。</li>
</ul>
<h1 id="gRPC-Demo-on-Python"><a href="#gRPC-Demo-on-Python" class="headerlink" title="gRPC Demo on Python"></a>gRPC Demo on Python</h1><h2 id="Install-gRPC-python-lib"><a href="#Install-gRPC-python-lib" class="headerlink" title="Install gRPC python lib"></a>Install gRPC python lib</h2><p>可以直接通过 pip 来安装相关的第三方库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install grpcio</span><br><span class="line">pip install protobuf</span><br><span class="line">pip install grpcio-tools</span><br></pre></td></tr></table></figure>

<h2 id="Define-gRPC-interface"><a href="#Define-gRPC-interface" class="headerlink" title="Define gRPC interface"></a>Define gRPC interface</h2><p>编写接口文件 data.proto：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line">package demo;</span><br><span class="line">service AddNumber &#123;</span><br><span class="line">  rpc do_add(data) returns (data)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">message data &#123;</span><br><span class="line">  string text &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所示，设计了 service AddNumber，调用的方法为 do_add，参数为 data，内容为字符串格式。</p>
<h2 id="Build-protobuf"><a href="#Build-protobuf" class="headerlink" title="Build protobuf:"></a>Build protobuf:</h2><p>编译 protobuf， 然后会生成两个文件 data_pb2.py 和 data_pb2_grpc.py：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. ./data.proto</span><br></pre></td></tr></table></figure>

<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>主要为注册服务，实现业务逻辑和返回的数据，这里就调用了上一步编译出来的两个 modules</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> data_pb2, data_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line">ONE_DAY_IN_SECONDS = <span class="number">3600</span> * <span class="number">24</span></span><br><span class="line">HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">PORT = <span class="string">&#x27;8888&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddNumber</span>(<span class="params">data_pb2_grpc.AddNumberServicer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_add</span>(<span class="params">self, request, context</span>):</span></span><br><span class="line">        txt = request.text</span><br><span class="line">        txt = <span class="built_in">str</span>(<span class="built_in">int</span>(txt) + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> data_pb2.data(text = txt)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_server</span>():</span></span><br><span class="line">    grpcServer = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">4</span>))</span><br><span class="line">    <span class="comment"># 这里将AddNumber这个类的实例注册进了服务</span></span><br><span class="line">    data_pb2_grpc.add_AddNumberServicer_to_server(AddNumber(), grpcServer)</span><br><span class="line">    grpcServer.add_insecure_port(HOST + <span class="string">&#x27;:&#x27;</span> + PORT)</span><br><span class="line">    grpcServer.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(ONE_DAY_IN_SECONDS)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        grpcServer.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_server()</span><br></pre></td></tr></table></figure>

<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>这里对应编写了主机和端口，然后使用 AddNumberStub 服务，调用 do_add 方法。</p>
<p>在服务端那么便会执行对应的操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> data_pb2, data_pb2_grpc</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">PORT = <span class="string">&#x27;8888&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span></span><br><span class="line">	conn = grpc.insecure_channel(HOST + <span class="string">&#x27;:&#x27;</span> + PORT)</span><br><span class="line">	client = data_pb2_grpc.AddNumberStub(channel=conn)</span><br><span class="line">	response = client.do_add(data_pb2.data(text=<span class="string">&#x27;3&#x27;</span>))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;received: &quot;</span> + response.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	run()</span><br></pre></td></tr></table></figure>

<p>下面是运行 client 的结果：</p>
<p>传过去的是 3，通过+1 最后得到的是 4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\gRPC_Demo&gt; python client.py</span><br><span class="line">received: 4</span><br></pre></td></tr></table></figure>

<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>RPC 实现的细节还有很多，包括序列化与反序列化，动态代理，网络通信NIO等，有机会再深入研究下。</p>
<hr>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/tree/master/RPC/py_gRPC_Demo">https://github.com/bearfly1990/PowerScript/tree/master/RPC/py_gRPC_Demo</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/iodjSVf8U1J7KYc/article/details/80681627">深入理解 RPC : 基于 Python 自建分布式高并发 RPC 服务</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/14e6f5217f40">Python RPC 之 gRPC</a> - 谢烟客</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangyunpeng0319/article/details/78651998">RPC 服务和 HTTP 服务对比</a> - wangyunpeng0319</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_16681169/article/details/72512819">HSF 的原理分析</a> - zxcodestudy</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-11-18T16:00:00.000Z" title="2018/11/19 上午12:00:00">2018-11-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-19T01:23:54.297Z" title="2018/11/19 上午9:23:54">2018-11-19</time></span><span class="level-item"> BF </span><span class="level-item">8 minutes read (About 1212 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/19/2018/11/2018-11-19-DesignPattern-Proxy/">Design Patterns(Proxy)</a></h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>早些年看《大话设计模式》的时候，用<code>Java</code>实现了书中的例子，可惜当年没有保存好，好多东西都丢了。</p>
<p>现在想着用<code>python</code>重新实现一下 ，重新学习。</p>
<p>虽然 python 没有接口的概念，但是可以用抽象类代替。</p>
<h1 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h1><p>代理模式是给某一个对象提供一个代理对象，并由代理对象控制对原对象的引用。通俗的来讲代理模式就是我们生活中常见的中介。</p>
<p><img src="/img/post/2018/11/2018-11-19-DesignPattern-Proxy.jpg" alt="proxy"></p>
<p><strong>为什么要用代理模式？</strong></p>
<p><strong>中介隔离作用：</strong></p>
<p>在某些情况下，一个客户类不想或者不能直接引用一个委托对象，而代理类对象可以在客户类和委托对象之间起到中介的作用，其特征是代理类和委托类实现相同的接口。</p>
<p><strong>开闭原则，增加功能：</strong></p>
<p>代理类除了是客户类和委托类的中介之外，我们还可以通过给代理类增加额外的功能来扩展委托类的功能，这样做我们只需要修改代理类而不需要再修改委托类，符合代码设计的开闭原则。</p>
<p>代理类主要负责为委托类预处理消息、过滤消息、把消息转发给委托类，以及事后对返回结果的处理等。代理类本身并不真正实现服务，而是同过调用委托类的相关方法，来提供特定的服务。</p>
<p>真正的业务功能还是由委托类来实现，但是可以在业务功能执行的前后加入一些公共的服务。例如我们想给项目加入缓存、日志这些功能，我们就可以使用代理类来完成，而没必要打开已经封装好的委托类。</p>
<p><strong>有哪几种代理模式？</strong></p>
<p>我们有多种不同的方式来实现代理。如果按照代理创建的时期来进行分类的话， 可以分为两种：<strong>静态代理</strong>、<strong>动态代理</strong>。</p>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><p>静态代理是由程序员创建或特定工具自动生成源代码，在对其编译。</p>
<p>下面这个是以购买房子为例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta,abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IBuyHouseMan</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_money</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        :param money:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyHouseManImpl</span>(<span class="params">IBuyHouseMan</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_money</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pay money(&#123;&#125;) for house!&quot;</span>.<span class="built_in">format</span>(money))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyHouseManProxy</span>(<span class="params">IBuyHouseMan</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, buy_house_man</span>):</span></span><br><span class="line">        self.buy_house_man = buy_house_man</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_money</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;prepare contract&quot;</span>)</span><br><span class="line">        self.buy_house_man.pay_money(money)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get commission &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    buy_house_man = BuyHouseManImpl()</span><br><span class="line">    buy_house_man.pay_money(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    buy_house_proxy = BuyHouseManProxy(buy_house_man)</span><br><span class="line">    buy_house_proxy.pay_money(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>动态代理是在程序运行时通过反射机制动态创建的，耦合性大大降低，更加灵活。</p>
<p>我对 python 的反射还不太熟悉，下面是网上的例子，感觉他写的有点麻烦和绕, 到时我重新写下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta,abstractmethod</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvocationHandler</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, obj, func</span>):</span></span><br><span class="line">        self.obj = obj</span><br><span class="line">        self.func = func</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;handler:&#x27;</span>, self.func, args, kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;before call the func.&#x27;</span>)</span><br><span class="line">        self.func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;after call the func.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HandlerException</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, cls</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(HandlerException, self).__init__(cls,  <span class="string">&#x27;is not a hanlder class&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, cls, hcls</span>):</span></span><br><span class="line">        self.cls = cls</span><br><span class="line">        self.hcls = hcls</span><br><span class="line">        self.handlers = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.obj = self.cls(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, attr</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;get attr:&#x27;</span>, attr)</span><br><span class="line">        isExist = <span class="built_in">hasattr</span>(self.obj, attr)</span><br><span class="line">        res = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> isExist:</span><br><span class="line">            res = <span class="built_in">getattr</span>(self.obj, attr)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(res, types.MethodType):</span><br><span class="line">                <span class="keyword">if</span> self.handlers.get(res) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    self.handlers[res] = self.hcls(self.obj, res)</span><br><span class="line">                <span class="keyword">return</span> self.handlers[res]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, hcls</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">issubclass</span>(hcls, InvocationHandler) <span class="keyword">or</span> hcls <span class="keyword">is</span> InvocationHandler:</span><br><span class="line">            self.hcls = hcls</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> HandlerException(hcls)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, cls</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Proxy(cls, self.hcls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ProxyFactory(<span class="params">InvocationHandler</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyHouseMan</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        self.money = money</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_money</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pay money(&#123;&#125;) for house!&quot;</span>.<span class="built_in">format</span>(self.money))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    buy_house_man  = BuyHouseMan(<span class="number">1000</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(buy_house_man))</span><br><span class="line">    buy_house_man.pay_money()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>如果使用 Java 的话，那么就很简单了，reflect类库中就有现成的<code>InvocationHandler</code>，很方便：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.java.proxy.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicProxyHandler</span><span class="params">(<span class="keyword">final</span> Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before invoke&quot;</span>);</span><br><span class="line">        Object result = method.invoke(object, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after invoke&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.java.proxy.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main.java.proxy.BuyHouse;</span><br><span class="line"><span class="keyword">import</span> main.java.proxy.impl.BuyHouseImpl;</span><br><span class="line"><span class="keyword">import</span> main.java.proxy.impl.DynamicProxyHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BuyHouse buyHouse = <span class="keyword">new</span> BuyHouseImpl();</span><br><span class="line">        BuyHouse proxyBuyHouse = (BuyHouse) Proxy.newProxyInstance(BuyHouse.class.getClassLoader(), <span class="keyword">new</span></span><br><span class="line">                Class[]&#123;BuyHouse.class&#125;, <span class="keyword">new</span> DynamicProxyHandler(buyHouse));</span><br><span class="line">        proxyBuyHouse.buyHosue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CGLIB代理"><a href="#CGLIB代理" class="headerlink" title="CGLIB代理"></a>CGLIB代理</h1><p>待填坑。</p>
<p><strong>参考:</strong></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/daniels/p/8242592.html">设计模式—代理模式</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/water_likud/article/details/80566177">Python：动态代理机制</a></p>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-11-09T16:00:00.000Z" title="2018/11/10 上午12:00:00">2018-11-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-10T15:33:01.453Z" title="2018/11/10 下午11:33:01">2018-11-10</time></span><span class="level-item"> BF </span><span class="level-item">4 minutes read (About 645 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/10/2018/11/2018-11-10-PyRestfulAPIDoc/">RESTful API Doc</a></h1><div class="content"><h1 id="RESTful-API-Doc"><a href="#RESTful-API-Doc" class="headerlink" title="RESTful API Doc"></a>RESTful API Doc</h1><p>针对<code>RESTful API</code>,有许多工具可以用来编写文档比如<code>Swagger2</code>，之前发现一个挺好用的库就是<a target="_blank" rel="noopener" href="http://apidocjs.com/">apidocjs</a></p>
<p>这个库支持大多数流行程序语言，把接口相关的信息放在注释中，而这个js库解析注释中的有效信息生成html文档，需要安装<code>node.js</code>。</p>
<h1 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h1><p>下面直接根据昨天的API例子来添加注释，生成文档。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> reqparse, abort, Api, Resource</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">api = Api(app)</span><br><span class="line"></span><br><span class="line">TODOS = &#123;</span><br><span class="line">    <span class="string">&#x27;todo1&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Build an API&#x27;</span>&#125;,</span><br><span class="line">    <span class="string">&#x27;todo2&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Test it&#x27;</span>&#125;,</span><br><span class="line">    <span class="string">&#x27;todo3&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Write Blog&#x27;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">abort_if_todo_doesnt_exist</span>(<span class="params">todo_id</span>):</span></span><br><span class="line">        <span class="keyword">if</span> todo_id <span class="keyword">not</span> <span class="keyword">in</span> TODOS:</span><br><span class="line">            abort(<span class="number">404</span>, message=<span class="string">&quot;Todo &#123;&#125; doesn&#x27;t exist.&quot;</span>.<span class="built_in">format</span>(todo_id))</span><br><span class="line"></span><br><span class="line">parser = reqparse.RequestParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;task&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Todo</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;get&#125; /todo/task/&lt;task_id&gt; get todo by id</span></span><br><span class="line"><span class="string">    @apiVersion 0.1.0</span></span><br><span class="line"><span class="string">    @apiName GetTodoItem</span></span><br><span class="line"><span class="string">    @apiGroup Todo</span></span><br><span class="line"><span class="string">    @apiPermission all</span></span><br><span class="line"><span class="string">    @apiParam &#123;Number&#125; task_id The todo id.</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todo/task/todo1</span></span><br><span class="line"><span class="string">    @apiSuccessExample &#123;json&#125; Success-Response:</span></span><br><span class="line"><span class="string">        HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">        &#123;&#x27;task&#x27;: &#x27;Build an API&#x27;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;get&#125; /todo/&lt;todo_id&gt; get todo by id</span></span><br><span class="line"><span class="string">    @apiVersion 0.2.0</span></span><br><span class="line"><span class="string">    @apiName GetTodoItem</span></span><br><span class="line"><span class="string">    @apiGroup Todo</span></span><br><span class="line"><span class="string">    @apiPermission all</span></span><br><span class="line"><span class="string">    @apiParam &#123;Number&#125; todo_id The todo id.</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todo/todo1</span></span><br><span class="line"><span class="string">    @apiSuccessExample &#123;json&#125; Success-Response:</span></span><br><span class="line"><span class="string">        HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">        &#123;&#x27;task&#x27;: &#x27;Build an API&#x27;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        abort_if_todo_doesnt_exist(todo_id)</span><br><span class="line">        <span class="keyword">return</span> TODOS[todo_id]</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;delete&#125; /todo/&lt;todo_id&gt; delete todo task by id</span></span><br><span class="line"><span class="string">    @apiVersion 0.1.0</span></span><br><span class="line"><span class="string">    @apiName DeleteTodo</span></span><br><span class="line"><span class="string">    @apiGroup Todo</span></span><br><span class="line"><span class="string">    @apiPermission admin</span></span><br><span class="line"><span class="string">    @apiParam &#123;Number&#125; todo_id The todo id.</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todo/todo1</span></span><br><span class="line"><span class="string">    @apiSuccessExample &#123;json&#125; Success-Response:</span></span><br><span class="line"><span class="string">        HTTP/1.1 204 No Content</span></span><br><span class="line"><span class="string">    @apiErrorExample Response (example):</span></span><br><span class="line"><span class="string">        HTTP/1.1 401 Not Authenticated</span></span><br><span class="line"><span class="string">        &#123;&quot;error&quot;: &quot;NoAccessRight&quot;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        abort_if_todo_doesnt_exist(todo_id)</span><br><span class="line">        <span class="keyword">del</span> TODOS[todo_id]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="number">204</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;put&#125; /todo/&lt;todo_id&gt; put a new task</span></span><br><span class="line"><span class="string">    @apiVersion 0.1.0</span></span><br><span class="line"><span class="string">    @apiName PutTask</span></span><br><span class="line"><span class="string">    @apiGroup Todo</span></span><br><span class="line"><span class="string">    @apiPermission admin</span></span><br><span class="line"><span class="string">    @apiParam &#123;Number&#125; todo_id The todo id.</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todo/todo1</span></span><br><span class="line"><span class="string">        &#123;&quot;task&quot;: &quot;New Task&quot;&#125;</span></span><br><span class="line"><span class="string">    @apiSuccessExample &#123;json&#125; Success-Response:</span></span><br><span class="line"><span class="string">        HTTP/1.1 201 Created </span></span><br><span class="line"><span class="string">        &#123;&quot;task&quot;: &quot;New Task&quot;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        args = parser.parse_args()</span><br><span class="line">        task = &#123;<span class="string">&#x27;task&#x27;</span>: args[<span class="string">&#x27;task&#x27;</span>]&#125;</span><br><span class="line">        <span class="keyword">return</span> task, <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoList</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;get&#125; /todos get todolist</span></span><br><span class="line"><span class="string">    @apiVersion 0.1.0</span></span><br><span class="line"><span class="string">    @apiName GetTodoList</span></span><br><span class="line"><span class="string">    @apiGroup TodoList</span></span><br><span class="line"><span class="string">    @apiPermission all</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todos</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> TODOS</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @api &#123;post&#125; /todos post todo list</span></span><br><span class="line"><span class="string">    @apiVersion 0.1.0</span></span><br><span class="line"><span class="string">    @apiName PostTodoList</span></span><br><span class="line"><span class="string">    @apiGroup TodoList</span></span><br><span class="line"><span class="string">    @apiPermission admin</span></span><br><span class="line"><span class="string">    @apiExample Example usage:</span></span><br><span class="line"><span class="string">        https://localhost:5000/v1/todo/todo1</span></span><br><span class="line"><span class="string">        &#123;&quot;task&quot;:&quot;New Task&quot;&#125;</span></span><br><span class="line"><span class="string">    @apiSuccessExample &#123;json&#125; Success-Response:</span></span><br><span class="line"><span class="string">        HTTP/1.1 201 Created</span></span><br><span class="line"><span class="string">        &#123;&#x27;task&#x27;: &#x27;New Task&#x27;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">        args = parser.parse_args()</span><br><span class="line">        todo_id = <span class="built_in">int</span>(<span class="built_in">max</span>(TODOS.keys()).lstrip(<span class="string">&#x27;todo&#x27;</span>)) + <span class="number">1</span></span><br><span class="line">        todo_id = <span class="string">&#x27;todo%i&#x27;</span> % todo_id</span><br><span class="line">        TODOS[todo_id] = &#123;<span class="string">&#x27;task&#x27;</span>: args[<span class="string">&#x27;task&#x27;</span>]&#125;</span><br><span class="line">        <span class="keyword">return</span> TODOS[todo_id], <span class="number">201</span></span><br><span class="line"></span><br><span class="line">api.add_resource(TodoList, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">api.add_resource(Todo, <span class="string">&#x27;/todos/&lt;todo_id&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行下面的命令，就可以在<code>pytrestapi_doc</code>目录下生成api文档</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\mayn\Desktop\workspace&gt; apidoc <span class="literal">-i</span> .\pyrestapi\ <span class="literal">-o</span> .\pytrestapi_doc</span><br><span class="line">info: Done.</span><br></pre></td></tr></table></figure>

<p>下面是报告的结果,可以感受下：<br><a href="https://bearfly1990.github.io/apidoc/pyrestapi-doc/">https://bearfly1990.github.io/apidoc/pyrestapi-doc/</a></p>
<p>下面是简单的环境配置步骤：</p>
<ul>
<li>安装<code>node.js</code></li>
<li>安装 apidoc <code>npm install apidoc -g</code></li>
<li>装备好已经编写好对应注释的代码项目</li>
<li><code>apidoc -i myapp/ -o apidoc/</code>  就能生成在apidoc文件夹中</li>
</ul>
<p>更多信息请参考官网：</p>
<p><a target="_blank" rel="noopener" href="http://apidocjs.com/">apidocjs</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-11-08T16:00:00.000Z" title="2018/11/9 上午12:00:00">2018-11-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-27T16:45:53.183Z" title="2018/11/28 上午12:45:53">2018-11-28</time></span><span class="level-item"> BF </span><span class="level-item">5 minutes read (About 822 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/09/2018/11/2018-11-09-PyRestfulAPI/">Python RESTful API</a></h1><div class="content"><h1 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h1><p>REST 全称是 Representational State Transfer，中文意思是表述性状态转移。 它首次出现在 2000 年 Roy Fielding 的博士论文中，Roy Fielding 是 HTTP 规范的主要编写者之一。 他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下，理解和评估以网络为基础的应用软件的架构设计，得到一个功能强、性能好、适宜通信的架构。REST 指的是一组架构约束条件和原则。” 如果一个架构符合 REST 的约束条件和原则，我们就称它为 RESTful 架构。</p>
<p>REST 本身并没有创造新的技术、组件或服务，而隐藏在 RESTful 背后的理念就是使用 Web 的现有特征和能力， 更好地使用现有 Web 标准中的一些准则和约束。虽然 REST 本身受 Web 技术的影响很深， 但是理论上 REST 架构风格并不是绑定在 HTTP 上，只不过目前 HTTP 是唯一与 REST 相关的实例。 所以我们这里描述的 REST 也是通过 HTTP 实现的 REST。</p>
<h1 id="Python-flask-restful"><a href="#Python-flask-restful" class="headerlink" title="Python flask-restful"></a>Python flask-restful</h1><p><code>flask</code>是 python 的一个轻量级网站开发框架，直接利用他就能开发简单的<code>web api</code>。</p>
<p>但是使用<code>flask-restful</code>的话，就更加的简单和适合。</p>
<h1 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h1><p>下面是直接使用 flask 的例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/helloworld&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>上面是一个非常简单的使用 flask 开发 api 的例子，在运行后直接就能访问使用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\mayn\Desktop&gt; python ./hello.py</span><br><span class="line"> * Serving Flask app <span class="string">&quot;hello&quot;</span> (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: <span class="keyword">Do</span> not use the development server <span class="keyword">in</span> a production environment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: <span class="number">215</span><span class="literal">-586</span><span class="literal">-846</span></span><br><span class="line"> * Running on http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/ (Press CTRL+C to quit)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/11/2018-11-09-PyRestfulAPI-demo01.jpg" alt="sample01"></p>
<h1 id="flask-restful"><a href="#flask-restful" class="headerlink" title="flask-restful"></a>flask-restful</h1><p>如果使用<code>flask-restful</code>的话，那就会结构更清晰一些：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> reqparse, abort, Api, Resource</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">api = Api(app)</span><br><span class="line"></span><br><span class="line">TODOS = &#123;</span><br><span class="line">    <span class="string">&#x27;todo1&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Build an API&#x27;</span>&#125;,</span><br><span class="line">    <span class="string">&#x27;todo2&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Test it&#x27;</span>&#125;,</span><br><span class="line">    <span class="string">&#x27;todo3&#x27;</span>: &#123;<span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;Write Blog&#x27;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">abort_if_todo_doesnt_exist</span>(<span class="params">todo_id</span>):</span></span><br><span class="line">        <span class="keyword">if</span> todo_id <span class="keyword">not</span> <span class="keyword">in</span> TODOS:</span><br><span class="line">            abort(<span class="number">404</span>, message=<span class="string">&quot;Todo &#123;&#125; doesn&#x27;t exist.&quot;</span>.<span class="built_in">format</span>(todo_id))</span><br><span class="line"></span><br><span class="line">parser = reqparse.RequestParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;task&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3个方法，对应get/delete/put</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Todo</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        abort_if_todo_doesnt_exist(todo_id)</span><br><span class="line">        <span class="keyword">return</span> TODOS[todo_id]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        abort_if_todo_doesnt_exist(todo_id)</span><br><span class="line">        <span class="keyword">del</span> TODOS[todo_id]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="number">204</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, todo_id</span>):</span></span><br><span class="line">        args = parser.parse_args()</span><br><span class="line">        task = &#123;<span class="string">&#x27;task&#x27;</span>: args[<span class="string">&#x27;task&#x27;</span>]&#125;</span><br><span class="line">        <span class="keyword">return</span> task, <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2个方法，对应get/post</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoList</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> TODOS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">        args = parser.parse_args()</span><br><span class="line">        todo_id = <span class="built_in">int</span>(<span class="built_in">max</span>(TODOS.keys()).lstrip(<span class="string">&#x27;todo&#x27;</span>)) + <span class="number">1</span></span><br><span class="line">        todo_id = <span class="string">&#x27;todo%i&#x27;</span> % todo_id</span><br><span class="line">        TODOS[todo_id] = &#123;<span class="string">&#x27;task&#x27;</span>: args[<span class="string">&#x27;task&#x27;</span>]&#125;</span><br><span class="line">        <span class="keyword">return</span> TODOS[todo_id], <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定api对应的类</span></span><br><span class="line">api.add_resource(TodoList, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">api.add_resource(Todo, <span class="string">&#x27;/todos/&lt;todo_id&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>总体来说，使用<code>flask-restful</code>框架真的方便很多, 一些处理已经封装好。比如<code>json</code>就是默认的输入输出，状态状态码也直接放在 return 中和返回的内容一起就好。</p>
<p>更多信息请参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/bearfly1990/PowerScript/blob/master/Python3/flask-restful/todo.py">todo.py</a></p>
<p><a target="_blank" rel="noopener" href="http://www.runoob.com/w3cnote/restful-architecture.html">RESTful 架构详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6ac1cab17929">python 实现 RESTful 服务（基于 flask)</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-10-26T16:00:00.000Z" title="2018/10/27 上午12:00:00">2018-10-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-08T13:28:21.887Z" title="2018/11/8 下午9:28:21">2018-11-08</time></span><span class="level-item"> BF </span><span class="level-item">7 minutes read (About 1070 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/27/2018/10/2018-10-27-PyScreenGif/">Python Screen Gif</a></h1><div class="content"><h1 id="2018-10-22"><a href="#2018-10-22" class="headerlink" title="2018-10-22"></a>2018-10-22</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>最近用了一些 gif 生成工具，感觉挺好用的，就想着 python 是不是也可以实现，自己做一个。</p>
<p>浏览了一些文章，发现有一些现成的库可以用。</p>
<p>最终的想法还是做成一个 GUI，今天是第一步，思路利用<code>PIL</code>的<code>ImageGrab</code>抓取屏幕，然后使用<code>opencsv</code>写入视频流，再用<code>moviepy</code>截取视频的画面生成 gif。</p>
<h2 id="Lib-Installed"><a href="#Lib-Installed" class="headerlink" title="Lib Installed"></a>Lib Installed</h2><p>下面是主要用的库，<code>pillow</code>就是<code>PIL</code>， <code>opencv-python</code>就是<code>cv2</code>。</p>
<p>在使用<code>moviepy</code>的时候，会需要下载第三方 exe <a target="_blank" rel="noopener" href="https://github.com/imageio/imageio-binaries/raw/master/ffmpeg/ffmpeg-win32-v3.2.4.exe">ffmpeg-win32-v3.2.4.exe</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br><span class="line">pip install opencv-python</span><br><span class="line">pip install moviepy</span><br></pre></td></tr></table></figure>

<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> moviepy.editor <span class="keyword">as</span> mpy</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"></span><br><span class="line">OUTPUT_NAME = <span class="string">&#x27;test&#x27;</span></span><br><span class="line"></span><br><span class="line">screen_grabed = ImageGrab.grab()  <span class="comment"># 获得当前屏幕</span></span><br><span class="line">k = np.zeros((<span class="number">200</span>, <span class="number">200</span>), np.uint8)</span><br><span class="line">width, height = screen_grabed.size  <span class="comment"># 获得当前屏幕的大小</span></span><br><span class="line"></span><br><span class="line">fourcc = cv2.VideoWriter_fourcc(*<span class="string">&#x27;XVID&#x27;</span>)  <span class="comment"># 编码格式</span></span><br><span class="line"></span><br><span class="line">video = cv2.VideoWriter(<span class="string">&#x27;&#123;&#125;.avi&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">    OUTPUT_NAME), fourcc, <span class="number">16</span>, (width, height))  <span class="comment"># 输出文件命名为test.avi,帧率为16，可以自己设置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    im = ImageGrab.grab()</span><br><span class="line">    imm = cv2.cvtColor(np.array(im), cv2.COLOR_RGB2BGR)  <span class="comment"># 转为opencv的BGR格式</span></span><br><span class="line">    video.write(imm)</span><br><span class="line">    cv2.imshow(<span class="string">&#x27;imm&#x27;</span>, k)</span><br><span class="line">    <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">video.release()</span><br><span class="line">cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line"><span class="comment">#import imageio</span></span><br><span class="line"><span class="comment"># imageio.plugins.ffmpeg.download()</span></span><br><span class="line"><span class="comment"># 视频文件的本地路径</span></span><br><span class="line">content = mpy.VideoFileClip(<span class="string">&#x27;&#123;&#125;.avi&#x27;</span>.<span class="built_in">format</span>(OUTPUT_NAME))</span><br><span class="line"><span class="comment"># 剪辑0分1秒到0分6秒的片段。注意：不使用resize则不会修改清晰度</span></span><br><span class="line">c1 = content.subclip((<span class="number">0</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="number">6</span>)).resize((<span class="number">960</span>, <span class="number">640</span>))</span><br><span class="line"><span class="comment"># 将片段保存为gif图到python的默认路径</span></span><br><span class="line">c1.write_gif(<span class="string">&#x27;&#123;&#125;.gif&#x27;</span>.<span class="built_in">format</span>(OUTPUT_NAME))</span><br></pre></td></tr></table></figure>

<h2 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h2><p>接下来，需要研究一下几个点：</p>
<ul>
<li>怎么使用 GUI 来录制固定区域的屏幕</li>
<li>是否可以截取图片流，再直接把图片打包成 gif，省去中间生成 avi 的过程。</li>
<li>…</li>
</ul>
<h1 id="2018-10-24"><a href="#2018-10-24" class="headerlink" title="2018-10-24"></a>2018-10-24</h1><h2 id="Background-1"><a href="#Background-1" class="headerlink" title="Background"></a>Background</h2><p>上一篇把截图做成视频，再把视频转回 gif 似乎有点画蛇添足，今天就考虑直接把截图转成 gif</p>
<h2 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, time</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"></span><br><span class="line">images = []</span><br><span class="line">start_time = time.time()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    im = ImageGrab.grab()</span><br><span class="line">    im.save(<span class="string">&#x27;temp.png&#x27;</span>)</span><br><span class="line">    <span class="comment">#save image to the list.</span></span><br><span class="line">    images.append(imageio.imread(<span class="string">&#x27;temp.png&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">0.001</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="keyword">if</span>(end_time - start_time &gt; <span class="number">5</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">imageio.mimsave(<span class="string">&#x27;test.gif&#x27;</span>, images, duration=<span class="number">0.3</span>)</span><br><span class="line">c1.write_gif(<span class="string">&#x27;&#123;&#125;.gif&#x27;</span>.<span class="built_in">format</span>(OUTPUT_NAME))</span><br></pre></td></tr></table></figure>

<h2 id="Next-1"><a href="#Next-1" class="headerlink" title="Next"></a>Next</h2><ul>
<li>怎么使用 GUI 来录制固定区域的屏幕</li>
<li>是否可以提高性能，每次截图放到 list 中性能消耗比较大</li>
<li>…</li>
</ul>
<h1 id="2018-10-27"><a href="#2018-10-27" class="headerlink" title="2018-10-27"></a>2018-10-27</h1><h2 id="Background-2"><a href="#Background-2" class="headerlink" title="Background"></a>Background</h2><p>今天更新了下代码，提高了可用性，增加了UI设定截屏的区域，有时间再更新这篇，已经基本可用了。</p>
<h2 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tkinter</span><br><span class="line"><span class="keyword">import</span> os, time, tempfile</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> msvcrt</span><br><span class="line"></span><br><span class="line">output_gif_name = <span class="string">&#x27;test.gif&#x27;</span></span><br><span class="line">width_grab = <span class="number">600</span></span><br><span class="line">height_grab = <span class="number">400</span></span><br><span class="line">x_grab = <span class="number">0</span></span><br><span class="line">y_grab = <span class="number">0</span></span><br><span class="line">flag_stop_record = [<span class="literal">False</span>]</span><br><span class="line">flag_is_recording = [<span class="literal">False</span>]</span><br><span class="line"></span><br><span class="line">root = tkinter.Tk()</span><br><span class="line">root.overrideredirect(<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#root.attributes(&quot;-alpha&quot;, 0.3)窗口透明度70 %</span></span><br><span class="line">root.attributes(<span class="string">&quot;-alpha&quot;</span>, <span class="number">0.3</span>)<span class="comment">#窗口透明度60 %</span></span><br><span class="line">root.geometry(<span class="string">&quot;&#123;&#125;x&#123;&#125;+&#123;&#125;+&#123;&#125;&quot;</span>.<span class="built_in">format</span>(width_grab, height_grab, x_grab,y_grab))<span class="comment">#&quot;300x200+10+10&quot;</span></span><br><span class="line">canvas = tkinter.Canvas(root)</span><br><span class="line">canvas.configure(width = width_grab)</span><br><span class="line">canvas.configure(height = height_grab)</span><br><span class="line">canvas.configure(bg = <span class="string">&quot;blue&quot;</span>)</span><br><span class="line">canvas.grid(column=<span class="number">0</span>,row=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># canvas.configure(highlightthickness = 0)</span></span><br><span class="line"><span class="comment"># canvas.pack()</span></span><br><span class="line"><span class="comment"># canvas.pack(side=&quot;bottom&quot;,fill=&quot;both&quot;,expand=True)</span></span><br><span class="line"><span class="comment"># x, y = 0, 0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="keyword">global</span> x_grab,y_grab, width_grab, height_grab</span><br><span class="line"></span><br><span class="line">    new_x = (event.x-x)+root.winfo_x()</span><br><span class="line">    new_y = (event.y-y)+root.winfo_y()</span><br><span class="line">    x_grab,y_grab = new_x,new_y</span><br><span class="line">    s = <span class="string">&quot;&#123;&#125;x&#123;&#125;+&#123;&#125;+&#123;&#125;&quot;</span>.<span class="built_in">format</span>(width_grab, height_grab, new_x, new_y)</span><br><span class="line">    <span class="comment"># s = &quot;&#123;&#125;x&#123;&#125;+&quot; + str(new_x)+&quot;+&quot; + str(new_y)</span></span><br><span class="line">    root.geometry(s)</span><br><span class="line">    <span class="comment"># canvas.create_rectangle(new_x, new_y, 300, 200, fill=&quot;blue&quot;)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;s = &quot;</span>,s)</span><br><span class="line">    <span class="built_in">print</span>(root.winfo_x(),root.winfo_y())</span><br><span class="line">    <span class="built_in">print</span>(event.x,event.y)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">button_1</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="keyword">global</span> x,y</span><br><span class="line">    x,y = event.x,event.y</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;x, y = &quot;</span>, x, y)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;event.x, event.y = &quot;</span>,event.x,event.y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_record_gif</span>():</span></span><br><span class="line">    <span class="keyword">global</span> output_gif_name, x_grab, y_grab, flag_stop_record</span><br><span class="line">    images_temp_list = []</span><br><span class="line">    <span class="comment"># start_time = time.time()</span></span><br><span class="line">    isEnded = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">not</span> isEnded):</span><br><span class="line">        <span class="keyword">if</span>(flag_stop_record[<span class="number">0</span>] == <span class="literal">True</span>):</span><br><span class="line">            isEnded = <span class="literal">True</span></span><br><span class="line">        <span class="comment"># try:</span></span><br><span class="line">            <span class="comment"># flag_stop_record.get(False)</span></span><br><span class="line">            <span class="comment"># isEnded = True</span></span><br><span class="line">        <span class="comment"># except:</span></span><br><span class="line">            <span class="comment"># isEnded = False</span></span><br><span class="line">        im = ImageGrab.grab((x_grab, y_grab , x_grab+width_grab, y_grab+height_grab))</span><br><span class="line">        im.save(<span class="string">&#x27;temp.png&#x27;</span>)</span><br><span class="line">        images_temp_list.append(imageio.imread(<span class="string">&#x27;temp.png&#x27;</span>))</span><br><span class="line">        time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        imageio.mimsave(output_gif_name, images_temp_list, duration=<span class="number">0.3</span>)</span><br><span class="line">        <span class="comment"># end_time = time.time()</span></span><br><span class="line">        <span class="comment"># if(end_time - start_time &gt; 5):</span></span><br><span class="line">            <span class="comment"># break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record_gif</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="keyword">global</span> flag_is_recording</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">not</span> flag_is_recording[<span class="number">0</span>]):</span><br><span class="line">        root.geometry(<span class="string">&quot;0x0+0+0&quot;</span>)</span><br><span class="line">        flag_is_recording[<span class="number">0</span>] = <span class="literal">True</span></span><br><span class="line">        t = Thread(target=start_record_gif, args=())</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="comment"># flag_stop_record.put(True)</span></span><br><span class="line">    flag_stop_record[<span class="number">0</span>] = <span class="literal">True</span></span><br><span class="line">    root.destroy()</span><br><span class="line"></span><br><span class="line">canvas.bind(<span class="string">&quot;&lt;B1-Motion&gt;&quot;</span>, move)</span><br><span class="line">canvas.bind(<span class="string">&quot;&lt;Button-1&gt;&quot;</span>, button_1)</span><br><span class="line">canvas.bind(<span class="string">&quot;&lt;Button-3&gt;&quot;</span>, exit)</span><br><span class="line">canvas.bind(<span class="string">&quot;&lt;Double-Button-1&gt;&quot;</span>,record_gif)</span><br><span class="line"></span><br><span class="line">root.mainloop()</span><br></pre></td></tr></table></figure>

<h2 id="Next-2"><a href="#Next-2" class="headerlink" title="Next"></a>Next</h2><ul>
<li>优化使用方式</li>
<li>使用temp目录</li>
<li>…</li>
</ul>
<p>更多信息可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Spade_/article/details/79516322">python小应用之moviepy的视频剪辑制作gif图</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zzzzjh/article/details/80903597">利用Python来完成屏幕录制</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-10-17T16:00:00.000Z" title="2018/10/18 上午12:00:00">2018-10-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-10-18T14:06:58.527Z" title="2018/10/18 下午10:06:58">2018-10-18</time></span><span class="level-item"> BF </span><span class="level-item">4 minutes read (About 643 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/18/2018/10/2018-10-18-PyWinService/">Python Windows Service</a></h1><div class="content"><h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>最近在优化<code>LoadTest</code>的流程，在执行测试的时候，我们需要在10台虚拟机上运行<code>HostProxy</code>, 这意味着需要登陆这10台机子并且一个个运行代理程序，这简直要人命。</p>
<p>所以我第一个想到的就是把这个过程做成一个<code>windows service</code>，让他们一直监控一个文件命令，当下达运行指令的时候，10台机子就会自动运行，同理也能停止。</p>
<p>虽然最后发现通过service启的进程不能被<code>Host Manager</code>访问到（有时间再仔细研究，应该有解决方案），用<code>Scheduler</code>替代了，但其它操作还是没有问题的。</p>
<h1 id="pywin32"><a href="#pywin32" class="headerlink" title="pywin32"></a>pywin32</h1><p>如果想要编写<code>windows service</code>，就要用到<code>pywin32</code>这个库，可以从网上下到，我记得好像不能直接使用pip安装。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><p>下面便是一个简单的例子，在服务启动之后，便会每5秒在文件中写数据。</p>
<p>主要我们自己的业务逻辑便是写在<code>SvcDoRun</code>这个函数中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> win32serviceutil</span><br><span class="line"><span class="keyword">import</span> win32service</span><br><span class="line"><span class="keyword">import</span> win32event</span><br><span class="line"><span class="keyword">import</span> servicemanager</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os, time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PySvc</span>(<span class="params">win32serviceutil.ServiceFramework</span>):</span></span><br><span class="line">    <span class="comment"># you can NET START/STOP the service by the following name</span></span><br><span class="line">    _svc_name_ = <span class="string">&quot;PythonTestService&quot;</span></span><br><span class="line">    <span class="comment"># this text shows up as the service name in the Service</span></span><br><span class="line">    <span class="comment"># Control Manager (SCM)</span></span><br><span class="line">    _svc_display_name_ = <span class="string">&quot;Python Test Service&quot;</span></span><br><span class="line">    <span class="comment"># this text shows up as the description in the SCM</span></span><br><span class="line">    _svc_description_ = <span class="string">&quot;This service writes stuff to a file&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args</span>):</span></span><br><span class="line">        win32serviceutil.ServiceFramework.__init__(self,args)</span><br><span class="line">        <span class="comment"># create an event to listen for stop requests on</span></span><br><span class="line">        self.hWaitStop = win32event.CreateEvent(<span class="literal">None</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># core logic of the service</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SvcDoRun</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># import servicemanager</span></span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&#x27;c:\\test.txt&#x27;</span>, <span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line">        rc = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># if the stop event hasn&#x27;t been fired keep looping</span></span><br><span class="line">        <span class="keyword">while</span> rc != win32event.WAIT_OBJECT_0:</span><br><span class="line">            f.write(<span class="string">&#x27;TEST DATA\n&#x27;</span>)</span><br><span class="line">            f.flush()</span><br><span class="line">            <span class="comment"># block for 5 seconds and listen for a stop event</span></span><br><span class="line">            rc = win32event.WaitForSingleObject(self.hWaitStop, <span class="number">5000</span>)</span><br><span class="line"></span><br><span class="line">        f.write(<span class="string">&#x27;Service is stopped.\n&#x27;</span>)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># called when we&#x27;re being shut down</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SvcStop</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># tell the SCM we&#x27;re shutting down</span></span><br><span class="line">        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)</span><br><span class="line">        <span class="comment"># fire the stop event</span></span><br><span class="line">        win32event.SetEvent(self.hWaitStop)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    win32serviceutil.HandleCommandLine(PySvc)</span><br></pre></td></tr></table></figure>

<h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><p>在编写好脚本之后，比如上面的代码假设文件名为<code>PythonService.py</code>,那么就可以用以下的方式来使用。</p>
<p>当然，在第一部安装之后，可以直接在<code>service</code>面板操作，不一定需要用脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#1.安装服务</span></span><br><span class="line">python PythonService.py install</span><br><span class="line"><span class="comment">#2.让服务自动启动</span></span><br><span class="line">python PythonService.py --startup auto install </span><br><span class="line"><span class="comment">#3.启动服务</span></span><br><span class="line">python PythonService.py start</span><br><span class="line"><span class="comment">#4.重启服务</span></span><br><span class="line">python PythonService.py restart</span><br><span class="line"><span class="comment">#5.停止服务</span></span><br><span class="line">python PythonService.py stop</span><br><span class="line"><span class="comment">#6.删除/卸载服务</span></span><br><span class="line">python PythonService.py remove</span><br></pre></td></tr></table></figure>

<p>更多信息可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zoro-robin/p/6110188.html">https://www.cnblogs.com/zoro-robin/p/6110188.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-09-11T16:00:00.000Z" title="2018/9/12 上午12:00:00">2018-09-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-11-30T15:46:40.248Z" title="2018/11/30 下午11:46:40">2018-11-30</time></span><span class="level-item"> BF </span><span class="level-item">7 minutes read (About 1085 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/12/2018/09/2018-09-12-PyProgressBar/">Progress Bar in Python</a></h1><div class="content"><h1 id="Progress-Bar-in-Python"><a href="#Progress-Bar-in-Python" class="headerlink" title="Progress Bar in Python"></a>Progress Bar in Python</h1><p>很多时候，我们在测试的过程中，希望能够直观的看到测试的进度，而不是去看 log 或者查询数据库得到信息。</p>
<p>这个时候，如果有数据完成的进度的话就非常的方便。</p>
<p>今天就简单总结下这两天查询的资料，并且已经在实际中用到。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>如果要在 Console 中实现进度条，那就是要所有所有字符全部在同一行，而且可以修改。</p>
<p>如果直接使用 print 语句，python 会结尾加上换行符(<code>\n</code>)，这就导致在 Console 下一旦被 print 之后就无法再修改了。所以我们不能直接使用 <code>print</code></p>
<p>通过 <code>sys.stdout.write()</code> 我们就可以在 Console 输出字符，并且不会加上任何结尾。</p>
<p>通过 <code>sys.stdout.flush()</code> 可以把输出暂时打印在 Console 中。</p>
<p>而通过转义字符<code>\r</code>，就可以回到首行，然后如果继续输出的话，就可以连续在同一行改变字符，实现进度的效果。</p>
<p>下面就简单介绍一些进度条的实现，网上一些作者的实例。</p>
<h2 id="Demo-01"><a href="#Demo-01" class="headerlink" title="Demo 01"></a>Demo 01</h2><p>下面是一个最简单的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    sys.stdout.write(<span class="string">&#x27;&#123;0&#125;\r&#x27;</span>.<span class="built_in">format</span>( <span class="string">&#x27;*&#x27;</span> * (i + <span class="number">1</span>)))</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo01.gif" alt="Demo01"></p>
<h2 id="Demo-02"><a href="#Demo-02" class="headerlink" title="Demo 02"></a>Demo 02</h2><p>这个例子是上一个例子的加强版，有数值进度和向后推进的箭头。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys,time</span><br><span class="line">j = <span class="string">&#x27;#&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">61</span>):</span><br><span class="line">    j += <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    sys.stdout.write(<span class="built_in">str</span>(<span class="built_in">int</span>((i/<span class="number">60</span>)*<span class="number">100</span>))+<span class="string">&#x27;% &#x27;</span>+j+<span class="string">&#x27;-&gt;&#x27;</span>+ <span class="string">&quot;\r&quot;</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo02.gif" alt="Demo02"></p>
<h2 id="Demo-03"><a href="#Demo-03" class="headerlink" title="Demo 03"></a>Demo 03</h2><p>这个例子更简单一些，只有进度的数值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">viewBar</span>(<span class="params">i</span>):</span></span><br><span class="line">    output = sys.stdout</span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, i + <span class="number">1</span>):</span><br><span class="line">        second = <span class="number">0.1</span></span><br><span class="line">        sleep(second)</span><br><span class="line">        output.write(<span class="string">&#x27;\rcomplete percent -----&gt;:%.0f%%&#x27;</span> % count)</span><br><span class="line">    output.flush()</span><br><span class="line">viewBar(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo03.gif" alt="Demo03"></p>
<h2 id="Demo-04"><a href="#Demo-04" class="headerlink" title="Demo 04"></a>Demo 04</h2><p>这个例子用了一个比较常用的第三方库<code>tqdm</code>,有兴趣大家可以去搜一下官方文档，还是比较灵活的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">500</span>), <span class="built_in">ascii</span>=<span class="literal">True</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo04.gif" alt="Demo04"></p>
<h2 id="Demo-05"><a href="#Demo-05" class="headerlink" title="Demo 05"></a>Demo 05</h2><p>这个例子其实和<code>Demo 02</code>差不多的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_bar</span>(<span class="params">num,total</span>):</span></span><br><span class="line">    rate = num / total</span><br><span class="line">    rate_num = <span class="built_in">int</span>(rate * <span class="number">100</span>)</span><br><span class="line">    <span class="comment">#r = &#x27;\r %d%%&#x27; %(rate_num)</span></span><br><span class="line">    r = <span class="string">&#x27;\r%s&gt;%d%%&#x27;</span> % (<span class="string">&#x27;=&#x27;</span> * rate_num, rate_num,)</span><br><span class="line">    sys.stdout.write(r)</span><br><span class="line">    sys.stdout.flush</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">101</span>):</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        view_bar(i, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo05.gif" alt="Demo05"></p>
<h2 id="Demo-06"><a href="#Demo-06" class="headerlink" title="Demo 06"></a>Demo 06</h2><p>这个例子是我觉得相对比较好的，自己改良了一下放在自己项目中用了，下面是原始的 sample，我加了线程的处理，这样就可以异步写进度，而不会影响原来的进程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> _thread</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShowProcess</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    显示处理进度的类</span></span><br><span class="line"><span class="string">    调用该类相关函数即可实现处理进度的显示</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    i = <span class="number">0</span> <span class="comment"># 当前的处理进度</span></span><br><span class="line">    max_steps = <span class="number">0</span> <span class="comment"># 总共需要处理的次数</span></span><br><span class="line">    max_arrow = <span class="number">50</span> <span class="comment">#进度条的长度</span></span><br><span class="line">    infoDone = <span class="string">&#x27;done&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化函数，需要知道总共的处理次数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, max_steps, infoDone = <span class="string">&#x27;Done&#x27;</span></span>):</span></span><br><span class="line">        self.max_steps = max_steps</span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line">        self.infoDone = infoDone</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示函数，根据当前的处理进度i显示进度</span></span><br><span class="line">    <span class="comment"># 效果为[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]100.00%</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_process</span>(<span class="params">self, i=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.i = i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.i += <span class="number">1</span></span><br><span class="line">        num_arrow = <span class="built_in">int</span>(self.i * self.max_arrow / self.max_steps) <span class="comment">#计算显示多少个&#x27;&gt;&#x27;</span></span><br><span class="line">        num_line = self.max_arrow - num_arrow <span class="comment">#计算显示多少个&#x27;-&#x27;</span></span><br><span class="line">        percent = self.i * <span class="number">100.0</span> / self.max_steps <span class="comment">#计算完成进度，格式为xx.xx%</span></span><br><span class="line">        process_bar = <span class="string">&#x27;[&#123;&#125;&#123;&#125;] &#123;:02&#125;%\r&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;#&#x27;</span> * num_arrow, <span class="string">&#x27;-&#x27;</span> * num_line,percent) <span class="comment">#带输出的字符串，&#x27;\r&#x27;表示不换行回到最左边#带输出的字符串，&#x27;\r&#x27;表示不换行回到最左边</span></span><br><span class="line">        sys.stdout.write(process_bar) <span class="comment">#这两句打印字符到终端</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        <span class="keyword">if</span> self.i &gt;= self.max_steps:</span><br><span class="line">            self.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(self.infoDone)</span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">VALUE = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_import</span>():</span></span><br><span class="line">    <span class="keyword">global</span> VALUE</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">        VALUE += <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">0.2</span> * random.random())</span><br><span class="line">        <span class="keyword">if</span> VALUE == <span class="number">100</span>:</span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monitor_process</span>(<span class="params"> threadName, delay</span>):</span></span><br><span class="line">    max_steps = <span class="number">100</span></span><br><span class="line">    process_bar = ShowProcess(max_steps, <span class="string">&#x27;OK&#x27;</span>) <span class="comment"># 1.在循环前定义类的实体， max_steps是总的步数， infoDone是在完成时需要显示的字符串</span></span><br><span class="line">    <span class="comment"># for i in range(max_steps):</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">        process_bar.show_process(VALUE)      <span class="comment"># 2.显示当前进度</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span>(VALUE == <span class="number">100</span>):</span><br><span class="line">            process_bar.show_process(<span class="number">100</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">_thread.start_new_thread( monitor_process, (<span class="string">&quot;Thread-1&quot;</span>, <span class="number">2</span>, ) )</span><br><span class="line">start_import()</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/2018/09/2018-09-12-PyProgressBar-demo06.gif" alt="Demo06"></p>
<p>更多信息可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jsben/p/5792952.html">https://www.cnblogs.com/jsben/p/5792952.html</a></p>
<p><a target="_blank" rel="noopener" href="https://pypi.org/project/tqdm/">https://pypi.org/project/tqdm/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-09-07T16:00:00.000Z" title="2018/9/8 上午12:00:00">2018-09-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-10-18T13:45:48.462Z" title="2018/10/18 下午9:45:48">2018-10-18</time></span><span class="level-item"> BF </span><span class="level-item">8 minutes read (About 1226 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/08/2018/09/2018-09-08-PyXPath/">XPath in Python</a></h1><div class="content"><h1 id="XPath-In-Python"><a href="#XPath-In-Python" class="headerlink" title="XPath In Python"></a>XPath In Python</h1><p>在对<code>XML</code>文件进行处理的时候，可以使用标准<code>DOM</code>的 api，但是相对来说不是很方便。</p>
<p>使用<code>XPath</code>的话就可以快速的定位节点，选取得到想要的值。</p>
<p>下面就对在<code>Python</code>中使用<code>XPath</code>处理<code>XML</code>文档做简单的介绍。</p>
<h2 id="XML-File"><a href="#XML-File" class="headerlink" title="XML File"></a>XML File</h2><p>下面是一个简单的<code>XML</code>的例子，可以看到基本的<code>Element</code>, <code>Node</code>, <code>Attribute</code>, <code>Text</code>等都是有的。</p>
<p>以<code>&lt;bookstore&gt;</code>为根结点，有多个<code>&lt;book&gt;</code>，每个<code>&lt;book&gt;</code>都有不同的种类，再下一层是书的<code>&lt;title&gt;</code> <code>&lt;author</code>等具体信息。</p>
<p>层次与内容还是比较清晰的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bookstore</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">book</span> <span class="attr">category</span>=<span class="string">&quot;COOKING&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>Everyday Italian<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>Giada De Laurentiis<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">year</span>&gt;</span>2005<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">price</span>&gt;</span>30.00<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">book</span> <span class="attr">category</span>=<span class="string">&quot;CHILDREN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>Harry Potter<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>J K. Rowling<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">year</span>&gt;</span>2005<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">price</span>&gt;</span>29.99<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">book</span> <span class="attr">category</span>=<span class="string">&quot;WEB&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>XQuery Kick Start<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>James McGovern<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>Per Bothner<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>Kurt Cagle<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>James Linn<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>Vaidyanathan Nagarajan<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">year</span>&gt;</span>2003<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">price</span>&gt;</span>49.99<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">book</span> <span class="attr">category</span>=<span class="string">&quot;WEB&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>Learning XML<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span>Erik T. Ray<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">year</span>&gt;</span>2003<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">price</span>&gt;</span>39.95<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">bookstore</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h2><p><code>XPath</code> 于 1999 年 11 月 16 日 成为 W3C 标准。</p>
<p><code>XPath</code> 被设计为供 <a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xsl/index.asp">XSLT</a>、<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xlink/index.asp">XPointer</a> 以及其他 XML 解析软件使用</p>
<p>下面主要简单介绍主要的语法：</p>
<h3 id="Select-Node"><a href="#Select-Node" class="headerlink" title="Select Node"></a>Select Node</h3><p><code>XPath</code> 使用路径表达式在 <code>XML</code> 文档中选取节点。节点是通过沿着路径或者 <code>step</code> 来选取的。</p>
<p>下面列出了最有用的路径表达式：</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nodename</td>
<td>选取此节点的所有子节点。</td>
</tr>
<tr>
<td>/</td>
<td>从根节点选取。</td>
</tr>
<tr>
<td>//</td>
<td>从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置。</td>
</tr>
<tr>
<td>.</td>
<td>选取当前节点。</td>
</tr>
<tr>
<td>..</td>
<td>选取当前节点的父节点。</td>
</tr>
<tr>
<td>@</td>
<td>选取属性。</td>
</tr>
</tbody></table>
<h3 id="Predicates"><a href="#Predicates" class="headerlink" title="Predicates"></a>Predicates</h3><p>谓语用来查找某个特定的节点或者包含某个指定的值的节点。</p>
<p>谓语被嵌在方括号中。</p>
<p>在下面的表格中，我们列出了带有谓语的一些路径表达式，以及表达式的结果：</p>
<table>
<thead>
<tr>
<th>路径表达式</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>/bookstore/book[1]</td>
<td>选取属于 bookstore 子元素的第一个 book 元素。</td>
</tr>
<tr>
<td>/bookstore/book[last()]</td>
<td>选取属于 bookstore 子元素的最后一个 book 元素。</td>
</tr>
<tr>
<td>/bookstore/book[last()-1]</td>
<td>选取属于 bookstore 子元素的倒数第二个 book 元素。</td>
</tr>
<tr>
<td>/bookstore/book[position()&lt;3]</td>
<td>选取最前面的两个属于 bookstore 元素的子元素的 book 元素。</td>
</tr>
<tr>
<td>//title[@lang]</td>
<td>选取所有拥有名为 lang 的属性的 title 元素。</td>
</tr>
<tr>
<td>//title[@lang=’eng’]</td>
<td>选取所有 title 元素，且这些元素拥有值为 eng 的 lang 属性。</td>
</tr>
<tr>
<td>/bookstore/book[price&gt;35.00]</td>
<td>选取 bookstore 元素的所有 book 元素，且其中的 price 元素的值须大于 35.00。</td>
</tr>
<tr>
<td>/bookstore/book[price&gt;35.00]/title</td>
<td>选取 bookstore 元素中的 book 元素的所有 title 元素，且其中的 price 元素的值须大于 35.00。</td>
</tr>
</tbody></table>
<h3 id="Unknow-Node"><a href="#Unknow-Node" class="headerlink" title="Unknow Node"></a>Unknow Node</h3><p>XPath 通配符可用来选取未知的 XML 元素。</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>匹配任何元素节点。</td>
</tr>
<tr>
<td>@*</td>
<td>匹配任何属性节点。</td>
</tr>
<tr>
<td>node()</td>
<td>匹配任何类型的节点。</td>
</tr>
</tbody></table>
<h3 id="Select-Several-Paths"><a href="#Select-Several-Paths" class="headerlink" title="Select Several Paths"></a>Select Several Paths</h3><p>通过在路径表达式中使用<code>|</code>运算符，可以选取若干个路径。</p>
<table>
<thead>
<tr>
<th>路径表达式</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>//book/title | //book/price</td>
<td>选取 book 元素的所有 title 和 price 元素。</td>
</tr>
<tr>
<td>//title | //price</td>
<td>选取文档中的所有 title 和 price 元素。</td>
</tr>
<tr>
<td>/bookstore/book/title | //price</td>
<td>选取属于 bookstore 元素的 book 元素的所有 title 元素，<br/>以及文档中所有的 price 元素。</td>
</tr>
</tbody></table>
<h2 id="Practise-in-python"><a href="#Practise-in-python" class="headerlink" title="Practise in python"></a>Practise in python</h2><p>下面主要简单介绍使用<code>xml.etree.ElementTree</code>在<code>python</code>中使用<code>XPath</code></p>
<h3 id="Get-node-by-text-value"><a href="#Get-node-by-text-value" class="headerlink" title="Get node by text value"></a>Get node by text value</h3><p>在上面的例子中，我们想要得到书名为<code>Learning XML</code>的书的信息，所以<code>XPath</code>路径应该为<code>//book[title=&#39;Learning XML&#39;]</code></p>
<p>然后再把信息打印出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line">xml_file_path = <span class="string">&#x27;sample.xml&#x27;</span></span><br><span class="line">xml_et  = ET.parse(xml_file_path)</span><br><span class="line"></span><br><span class="line">node_book = xml_et.find(<span class="string">&quot;.//book[title=&#x27;Learning XML&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(node_book)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(node_book.tag)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(node_book.attrib))</span><br><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> node_book:</span><br><span class="line">    <span class="built_in">print</span>(child.tag, child.attrib, child.text)</span><br></pre></td></tr></table></figure>

<p>output:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\python_test\xpath_in_python&gt; python .\xpath_python.py</span><br><span class="line">&lt;Element <span class="string">&#x27;book&#x27;</span> at 0x03642CC0&gt;</span><br><span class="line">book</span><br><span class="line">&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;WEB&#x27;</span>&#125;</span><br><span class="line">title &#123;<span class="string">&#x27;lang&#x27;</span>: <span class="string">&#x27;en&#x27;</span>&#125; Learning XML</span><br><span class="line">author &#123;&#125; Erik T. Ray</span><br><span class="line">year &#123;&#125; 2003</span><br><span class="line">price &#123;&#125; 39.95</span><br></pre></td></tr></table></figure>

<h3 id="Get-node-by-attribute-value"><a href="#Get-node-by-attribute-value" class="headerlink" title="Get node by attribute value"></a>Get node by attribute value</h3><p>如果我们想找到种类为<code>WEB</code>的所以的书，那我们可以用<code>.//book[@category=&#39;WEB&#39;]</code>。</p>
<p>但是如果我们还是用<code>find</code>的话，只能得到第一个符合条件的，所以我们需要用<code>findall</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line">xml_file_path = <span class="string">&#x27;sample.xml&#x27;</span></span><br><span class="line">xml_et  = ET.parse(xml_file_path)</span><br><span class="line"></span><br><span class="line">node_books = xml_et.findall(<span class="string">&quot;.//book[@category=&#x27;WEB&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(node_books)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node_book <span class="keyword">in</span> node_books:</span><br><span class="line">    <span class="built_in">print</span>(node_book.tag)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(node_book.attrib))</span><br><span class="line">    <span class="keyword">for</span> child <span class="keyword">in</span> node_book:</span><br><span class="line">        <span class="built_in">print</span>(child.tag, child.attrib, child.text)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\mayn\Desktop\python_test\xpath_in_python&gt; python .\xpath_python.py</span><br><span class="line">[&lt;Element &#x27;book&#x27; at 0x02F12AB0&gt;, &lt;Element &#x27;book&#x27; at 0x02F12CC0&gt;]</span><br><span class="line">book</span><br><span class="line">&#123;&#x27;category&#x27;: &#x27;WEB&#x27;&#125;</span><br><span class="line">title &#123;&#x27;lang&#x27;: &#x27;en&#x27;&#125; XQuery Kick Start</span><br><span class="line">author &#123;&#125; James McGovern</span><br><span class="line">author &#123;&#125; Per Bothner</span><br><span class="line">author &#123;&#125; Kurt Cagle</span><br><span class="line">author &#123;&#125; James Linn</span><br><span class="line">author &#123;&#125; Vaidyanathan Nagarajan</span><br><span class="line">year &#123;&#125; 2003</span><br><span class="line">price &#123;&#125; 49.99</span><br><span class="line">book</span><br><span class="line">&#123;&#x27;category&#x27;: &#x27;WEB&#x27;&#125;</span><br><span class="line">title &#123;&#x27;lang&#x27;: &#x27;en&#x27;&#125; Learning XML</span><br><span class="line">author &#123;&#125; Erik T. Ray</span><br><span class="line">year &#123;&#125; 2003</span><br><span class="line">price &#123;&#125; 39.95</span><br></pre></td></tr></table></figure>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>总之，因为<code>XML</code>的结构化特性，使用<code>XPath</code>能非常方便的去query我们想要的信息。</p>
<p>在<code>python</code>中，结合<code>ElementTree</code>的API，能很方便的操作XML文档。</p>
<p>更多信息可以参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/index.asp">http://www.w3school.com.cn/xpath/index.asp</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/xml.etree.elementtree.html">https://docs.python.org/3/library/xml.etree.elementtree.html</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/tags/python/page/2/">Previous</a></div><div class="pagination-next"><a href="/tags/python/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/tags/python/">1</a></li><li><a class="pagination-link" href="/tags/python/page/2/">2</a></li><li><a class="pagination-link is-current" href="/tags/python/page/3/">3</a></li><li><a class="pagination-link" href="/tags/python/page/4/">4</a></li><li><a class="pagination-link" href="/tags/python/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mybear.jpg" alt="bearfly1990"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">bearfly1990</p><p class="is-size-6 is-block">有熊在飞</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>HZ, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">100</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/bearfly1990" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/bearfly1990"><i class="fab fa-github"></i></a></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.ico" alt="BF Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 bearfly1990</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>